<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>fhirbuild API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>


            <h2>Submodules</h2>
            <ul>
                    <li><a href="fhirbuild/csvtofhir.html">csvtofhir</a></li>
                    <li><a href="fhirbuild/help.html">help</a></li>
            </ul>

            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#write_patients">write_patients</a>
            </li>
            <li>
                    <a class="function" href="#write_samples">write_samples</a>
            </li>
            <li>
                    <a class="function" href="#write_observations">write_observations</a>
            </li>
            <li>
                    <a class="function" href="#bundle">bundle</a>
            </li>
            <li>
                    <a class="function" href="#writeout">writeout</a>
            </li>
            <li>
                    <a class="function" href="#fhir_identifier">fhir_identifier</a>
            </li>
            <li>
                    <a class="function" href="#fhir_coding">fhir_coding</a>
            </li>
            <li>
                    <a class="function" href="#fhir_extension">fhir_extension</a>
            </li>
            <li>
                    <a class="function" href="#fhir_specimen">fhir_specimen</a>
            </li>
            <li>
                    <a class="function" href="#fhir_quantity">fhir_quantity</a>
            </li>
            <li>
                    <a class="function" href="#fhir_aliquotgroup">fhir_aliquotgroup</a>
            </li>
            <li>
                    <a class="function" href="#fhir_bundle">fhir_bundle</a>
            </li>
            <li>
                    <a class="function" href="#fhir_obs">fhir_obs</a>
            </li>
            <li>
                    <a class="function" href="#fhir_patient">fhir_patient</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
fhirbuild    </h1>

                
                        <input id="mod-fhirbuild-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-fhirbuild-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="c1"># fhirbuild builds fhir</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="c1"># vielleicht ist fhir-building aber schon besser wo anders geloest,</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="c1"># da muessten wir mal suchen, https://www.google.com/search?q=python+fhir+frameworks  </span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="c1"># vielleicht z.b. hier https://pypi.org/project/fhir.resources/</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tram</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sample</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">,</span> <span class="n">Patient</span><span class="p">,</span> <span class="n">Amount</span><span class="p">,</span> <span class="n">Finding</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tram</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rec</span><span class="p">,</span> <span class="n">BooleanRec</span><span class="p">,</span> <span class="n">NumberRec</span><span class="p">,</span> <span class="n">StringRec</span><span class="p">,</span> <span class="n">DateRec</span><span class="p">,</span> <span class="n">MultiRec</span><span class="p">,</span> <span class="n">CatalogRec</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">fhirbuild.help</span><span class="w"> </span><span class="kn">import</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">genfhirid</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="k">def</span><span class="w"> </span><span class="nf">write_patients</span><span class="p">(</span><span class="n">pats</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">should_print</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cxx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;write_patients writes fhir resources of patients and returns a list containing the written directory.&quot;&quot;&quot;</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>    <span class="c1"># get the entries</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>    <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">pats</span><span class="p">:</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>        <span class="c1"># make a fhirid that depends on the limspsn, the fhirid is  </span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_patient</span><span class="p">(</span><span class="n">pat</span><span class="p">))</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="c1"># bundles the entries </span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>    <span class="n">bundles</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="s2">&quot;Patient&quot;</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="n">cxx</span><span class="p">)</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="c1"># if print is set, print</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="k">if</span> <span class="n">should_print</span><span class="p">:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>    
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="c1"># write the bundles</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="k">return</span> <span class="n">writeout</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="s2">&quot;patient&quot;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">wrap</span><span class="p">)</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="k">def</span><span class="w"> </span><span class="nf">write_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">should_print</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cxx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;write_samples writes fhir resources of Samples and returns a list containing the written directory.&quot;&quot;&quot;</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="c1"># fill in fhirids, taking parent-child relations into account.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="n">_fill_in_fhirids</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="c1"># collect the entries</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>    <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>        <span class="c1"># build aliquot group or standard sample</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;ALIQUOTGROUP&quot;</span><span class="p">:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">fhir_aliquotgroup</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>        <span class="k">elif</span> <span class="n">sample</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;MASTER&quot;</span> <span class="ow">or</span> <span class="n">sample</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;DERIVED&quot;</span><span class="p">:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">fhir_specimen</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sample category </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">category</span><span class="si">}</span><span class="s2"> is not allowed.&quot;</span><span class="p">)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="c1"># append the entry</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>    <span class="c1"># bundles the entries</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>    <span class="n">bundles</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="n">cxx</span><span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>    <span class="c1"># if print is set, print</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="k">if</span> <span class="n">should_print</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="c1"># write the bundles</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>    <span class="k">return</span> <span class="n">writeout</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">wrap</span><span class="p">)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_fill_in_fhirids</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fill_in_fhirids fills in fhirids from parent-child relations via oid (between derived and aliquotgroup).&quot;&quot;&quot;</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>    <span class="c1"># remember the fhirids by oid</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="n">fhirids</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>    <span class="c1"># collect the entries</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="c1"># take the fhirid if passed</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="n">fhirid</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s2">&quot;fhirid&quot;</span><span class="p">)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="c1"># if no fhirid, generate a fhirid</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="k">if</span> <span class="n">fhirid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="c1"># if it&#39;s an aliquotgroup, generate a fhirid based on the parent id and aliquotgroup type.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;ALIQUOTGROUP&quot;</span><span class="p">:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>                <span class="n">fhirid</span> <span class="o">=</span> <span class="n">genfhirid</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">+</span> <span class="n">sample</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>                <span class="c1"># else generate the fhirid from the sampleid</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>                <span class="n">fhirid</span> <span class="o">=</span> <span class="n">genfhirid</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>                
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>            <span class="n">sample</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;fhirid&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">fhirid</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="c1"># print(&quot;parent:&quot; + str(sample.parent))</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="c1"># if the sample&#39;s parent has no fhirid or sampleid, try to set its fhirid from when we passed it in the loop (if we passed it).</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="n">pfhirid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="n">parent</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s2">&quot;fhirid&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="n">pfhirid</span> <span class="o">=</span> <span class="n">dig</span><span class="p">(</span><span class="n">fhirids</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s2">&quot;oid&quot;</span><span class="p">))</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>            
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="c1"># add the remembered fhirid for the parent</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="k">if</span> <span class="n">pfhirid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>            <span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Identifier</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pfhirid</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;fhirid&quot;</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="c1"># remember this entry&#39;s fhirid by its oid</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="n">fhirids</span><span class="p">[</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s2">&quot;oid&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fhirid</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="c1"># increase the index</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="k">def</span><span class="w"> </span><span class="nf">write_observations</span><span class="p">(</span><span class="n">findings</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">should_print</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;write_observations writes fhir resources of observations and returns a list containing the written directory.&quot;&quot;&quot;</span> 
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="c1"># get the entries</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="k">for</span> <span class="n">finding</span> <span class="ow">in</span> <span class="n">findings</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="c1"># make a fhirid from sampleid and method code</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="c1">#print(&quot;sampleid: &quot; + finding.sample.id())</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="c1">#print(&quot;method: &quot; + finding.method)</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="n">fhirid</span> <span class="o">=</span> <span class="n">genfhirid</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">+</span> <span class="n">finding</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_obs</span><span class="p">(</span><span class="n">finding</span><span class="p">,</span> <span class="n">fhirid</span><span class="o">=</span><span class="n">fhirid</span><span class="p">))</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>    <span class="c1"># bundles the entries</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="n">bundles</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="s2">&quot;Observation&quot;</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="c1"># if print is set, print</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="k">if</span> <span class="n">should_print</span><span class="p">:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="c1"># write the bundles</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="k">return</span> <span class="n">writeout</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">wrap</span><span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="k">def</span><span class="w"> </span><span class="nf">bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">restype</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cxx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;bundle puts n entries in a bundle each.&quot;&quot;&quot;</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="n">bundles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="c1"># after each n entries</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>            <span class="c1"># append a bundle of the full batch</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>            <span class="n">bundles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_bundle</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="n">restype</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="n">cxx</span><span class="p">))</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>            <span class="c1"># reset the batch</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="c1"># add to the batch</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>    <span class="c1"># append the last batch</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>    <span class="n">bundles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_bundle</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="n">restype</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="n">cxx</span><span class="p">))</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>    <span class="k">return</span> <span class="n">bundles</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>    
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>    
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="k">def</span><span class="w"> </span><span class="nf">writeout</span><span class="p">(</span><span class="n">bundles</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;writeout writes fhir bundles into a directory as seperate files, wrapping them into a timestamped directory if wrap is True.&quot;&quot;&quot;</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="c1"># wrap the output into a timestamped directory if wished</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>    <span class="n">outdir</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>    <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="n">outdir</span> <span class="o">=</span> <span class="nb">dir</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>    <span class="c1"># create the output directory</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>    <span class="c1"># how broad should the zero-place holder for the pagenumber in the filenames be? (eg for 999 pages 3, for 1000 pages 4)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>    <span class="n">page_num_width</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bundles</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>    <span class="c1"># write each bundle in a seperate file, using the same timestamp and increasing page numbers.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bundle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bundles</span><span class="p">):</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="n">fstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_p%0&quot;</span> <span class="o">+</span> <span class="n">page_num_width</span> <span class="o">+</span> <span class="s2">&quot;d.json&quot;</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">fstring</span> <span class="o">%</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="c1"># filename = timestamp + &quot;_&quot; + type + &quot;_p&quot; + str(i) + &quot;.json&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">outf</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>    <span class="c1"># for now, only return the directory path, not the paths of the written files</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>    <span class="k">return</span> <span class="p">[</span><span class="n">outdir</span><span class="p">]</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span><span class="n">Identifier</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;urn:centraxx&quot;</span><span class="p">):</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; fhirIdentifier returns a fhir identifier.&quot;&quot;&quot;</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>    <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="k">if</span> <span class="n">identifier</span><span class="o">.</span><span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;identifier or code for fhir identifier is None&quot;</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">id</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>    <span class="c1"># why also exclude &#39;NULL&#39;?    </span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>    <span class="c1">#if  id is None or id == &quot;&quot; or id == &quot;NULL&quot;:</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>    <span class="c1"># why error on missing values? is it because fhirimport doesn&#39;t take no null values? but that&#39;s not quite in the scope of fhirbuild to know, is it?</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>    
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;id for fhir identifier </span><span class="si">{</span><span class="n">identifier</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> is &#39;</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="c1"># set the id to None if &#39;NULL&#39; was given? </span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>    <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>                <span class="n">fhir_coding</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>            <span class="p">]</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="p">},</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">identifier</span><span class="o">.</span><span class="n">id</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>    <span class="p">}</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;urn:centraxx&quot;</span><span class="p">):</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_coding returns a fhir coding with code and system.&quot;&quot;&quot;</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">system</span><span class="p">,</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>    <span class="p">}</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_extension</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_extension returns a extension with url and puts everything from dict d in it.&quot;&quot;&quot;</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>    <span class="n">ext</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="n">ext</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>    <span class="k">return</span> <span class="n">ext</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_specimen</span><span class="p">(</span><span class="n">sample</span><span class="p">:</span><span class="n">Sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                <span class="n">update_with_overwrite</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span> 
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_specimen builds a fhir specimen. pass the sample&#39;s fhirid as an Identifier with code &quot;fhirid&quot; for the sample, and, for deriveds, the fhirid of its parent aliquotgroup as an Identifier with code &quot;fhirid&quot; of sample.parent. by tying the fhirids directly to the sample, calling methods can receive fhirids for lists of Samples e.g. from csv without having to sneak them in via an extra argument.&quot;&quot;&quot;</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>    <span class="c1"># todo also build aliquotgroups?</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>    
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>    <span class="c1"># print(f&quot;fhir_specimen: {sample.category} {fhirid} {sample.collected_date} {sample.xposition} {sample.yposition}&quot;)</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>    
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Specimen&quot;</span><span class="p">,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                    <span class="s2">&quot;https://fhir.centraxx.de/extension/updateWithOverwrite&quot;</span><span class="p">,</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>                    <span class="p">{</span> <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="n">update_with_overwrite</span> <span class="p">}</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                <span class="p">),</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                <span class="c1"># reposition date added later</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                <span class="c1"># location path added later</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                    <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/organizationUnit&quot;</span><span class="p">,</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                    <span class="p">{</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                        <span class="s2">&quot;valueReference&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>                        <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">orga</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                        <span class="p">}</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                    <span class="p">}</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="p">}),</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                    <span class="s2">&quot;https://fhir.centraxx.de/extension/sampleCategory&quot;</span><span class="p">,</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                    <span class="p">{</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                        <span class="s2">&quot;valueCoding&quot;</span><span class="p">:</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">category</span><span class="p">))</span> 
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                    <span class="p">}</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="p">],</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># filled later</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;available&quot;</span><span class="p">,</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                    <span class="c1"># type (material) added later</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                <span class="p">]</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>            <span class="p">},</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="p">},</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="c1"># &quot;receivedTime&quot;: # added later</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>            <span class="c1"># &quot;parent&quot;: [ ], # filled later</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="s2">&quot;collection&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                <span class="c1"># &quot;collectedDateTime&quot;: collected_date, # added later</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                <span class="c1"># &quot;quantity&quot;: initial_amount # added later</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="p">},</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>            <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="p">[</span> 
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                <span class="p">{</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>                    <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                        <span class="p">{</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:centraxx&quot;</span><span class="p">,</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">receptacle</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                        <span class="p">}</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                    <span class="p">],</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                    <span class="c1"># &quot;capacity&quot;: capacity, # wird nicht gesetzt, hat keinen einfluss auf cxx</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                    <span class="c1"># &quot;specimenQuantity&quot;: # is restamount, added later</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                <span class="p">}</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="p">]</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="p">},</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="p">}</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>    <span class="p">}</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>    <span class="c1"># fill the identifiers.  skip the oid for now</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">sample</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>         <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;oid&quot;</span> <span class="ow">and</span> <span class="nb">id</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;fhirid&quot;</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>             <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_identifier</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>    
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>    <span class="c1"># bundle the values that end up in the sprec extension</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>    <span class="n">sprecext</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec&quot;</span><span class="p">,</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="p">{</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/useSprec&quot;</span><span class="p">,</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>            <span class="p">}</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="p">]</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>    <span class="p">}</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>    <span class="c1"># none checks for values.</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>    <span class="c1"># the fhir importer apparently doesn&#39;t import null values, so only put in values if they aren&#39;t none.</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>    <span class="c1"># this would make deleting values impossible at the moment.</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>    <span class="c1"># does cxx4 fhir import accept null values?</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>    <span class="c1"># first stock processing (centrifugation)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>    
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">stockprocessing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="c1"># append the stock processing sprec</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="n">sprecext</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/stockProcessing&quot;</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="p">{</span> <span class="s2">&quot;valueCoding&quot;</span><span class="p">:</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">stockprocessing</span><span class="p">)</span> <span class="p">}</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="p">))</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">stockprocessingdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="c1"># append the stock processing date sprec</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="n">sprecext</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/stockProcessingDate&quot;</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="p">{</span> <span class="s2">&quot;valueDateTime&quot;</span><span class="p">:</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">stockprocessingdate</span><span class="p">)</span> <span class="p">}</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="p">))</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>    <span class="c1"># second stock processing (centrifugation)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>    
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">secondprocessing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="c1"># append the second processing sprec</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="n">sprecext</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/secondProcessing&quot;</span><span class="p">,</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="p">{</span> <span class="s2">&quot;valueCoding&quot;</span><span class="p">:</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">secondprocessing</span><span class="p">)</span> <span class="p">}</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="p">))</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">secondprocessingdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="c1"># append the second processing date sprec</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="n">sprecext</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/secondProcessingDate&quot;</span><span class="p">,</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>            <span class="p">{</span> <span class="s2">&quot;valueDateTime&quot;</span><span class="p">:</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">secondprocessingdate</span><span class="p">)</span> <span class="p">}</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>        <span class="p">))</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>    <span class="c1"># add the sprec extension to the extensions</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sprecext</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">locationpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>            <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                    <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/sampleLocation&quot;</span><span class="p">,</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                    <span class="p">{</span> <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                        <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>                            <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/sampleLocationPath&quot;</span><span class="p">,</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                            <span class="p">{</span><span class="s2">&quot;valueString&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">locationpath</span><span class="p">)</span> <span class="p">}</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                        <span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                    <span class="p">]}</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>                <span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">derivaldate</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/derivalDate&quot;</span><span class="p">,</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            <span class="p">{</span> <span class="s2">&quot;valueDateTime&quot;</span><span class="p">:</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">derivaldate</span><span class="p">)</span> <span class="p">}</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="p">))</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">xposition</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="s1">&#39;extension&#39;</span><span class="p">]:</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/sampleLocation&quot;</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                <span class="c1"># fge xpos am Anfang ein</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                <span class="c1"># print(f&quot;xpos found, inserting xposition {xposition}&quot;)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>                <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;extension&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fhir_extension</span><span class="p">(</span><span class="s2">&quot;https://fhir.centraxx.de/extension/sample/xPosition&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;valueInteger&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">xposition</span><span class="p">)</span> <span class="p">}))</span> 
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">yposition</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="s1">&#39;extension&#39;</span><span class="p">]:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/sampleLocation&quot;</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                <span class="c1"># fge ypos als zweites ein</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                <span class="c1"># print(f&quot;ypos found, inserting yposition {yposition}&quot;)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;extension&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fhir_extension</span><span class="p">(</span><span class="s2">&quot;https://fhir.centraxx.de/extension/sample/yPosition&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;valueInteger&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">yposition</span><span class="p">)</span> <span class="p">}))</span> 
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    <span class="c1"># if the parent&#39;s fhirid is given, use it to reference the parent, else use the sampleid of the parent.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="p">{</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="p">}</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>    <span class="k">elif</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># todo check it&#39;s not none?</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="p">{</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>            <span class="p">}</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">concentration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/concentration&quot;</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="p">{</span><span class="s2">&quot;valueQuantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span> <span class="p">}</span> 
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>        <span class="p">))</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">samplingdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;collection&quot;</span><span class="p">][</span><span class="s2">&quot;collectedDateTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">samplingdate</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>  
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">receiptdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;receivedTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">receiptdate</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">repositiondate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/repositionDate&quot;</span><span class="p">,</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="p">{</span> <span class="s2">&quot;valueDateTime&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">repositiondate</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>        <span class="p">))</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">initialamount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;collection&quot;</span><span class="p">][</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fhir_quantity</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">initialamount</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">restamount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;container&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;specimenQuantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fhir_quantity</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">restamount</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">][</span><span class="s2">&quot;coding&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">type</span><span class="p">))</span> <span class="p">)</span> <span class="c1"># material</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>    <span class="k">return</span> <span class="n">entry</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_quantity</span><span class="p">(</span><span class="n">amount</span><span class="p">:</span><span class="n">Amount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;urn:centraxx&quot;</span><span class="p">):</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_quantity builds a fhir quantity.&quot;&quot;&quot;</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>    <span class="n">quant</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">amount</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="k">if</span> <span class="n">amount</span><span class="o">.</span><span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">system</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>    <span class="p">}</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>    <span class="k">return</span> <span class="n">quant</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_aliquotgroup</span><span class="p">(</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="n">sample</span><span class="p">:</span><span class="n">Sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="n">fhirid</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="n">parent_fhirid</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="n">update_with_overwrite</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="p">):</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_aliquotgroup builds a fhir aliquotgroup from a Sample. pass fhirids as Identifiers with code &quot;fhirid&quot; of sample and sample.parent.&quot;&quot;&quot;</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Specimen&quot;</span><span class="p">,</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                <span class="p">{</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/updateWithOverwrite&quot;</span><span class="p">,</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                    <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="n">update_with_overwrite</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="p">},</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="p">{</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/organizationUnit&quot;</span><span class="p">,</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                    <span class="s2">&quot;valueReference&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                        <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">orga</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                        <span class="p">}</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>                    <span class="p">}</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>                <span class="p">},</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="p">{</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sampleCategory&quot;</span><span class="p">,</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                    <span class="s2">&quot;valueCoding&quot;</span><span class="p">:</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;ALIQUOTGROUP&quot;</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                <span class="p">},</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                <span class="p">{</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec&quot;</span><span class="p">,</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                    <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/useSprec&quot;</span><span class="p">,</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>                        <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                    <span class="p">}]</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                <span class="p">}</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="p">],</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unavailable&quot;</span><span class="p">,</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>                    <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>                <span class="p">]</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>            <span class="p">},</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>            <span class="p">},</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            <span class="c1"># &quot;receivedTime&quot;: added later</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="p">],</span> <span class="c1"># filled later </span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="p">},</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="p">}</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>    <span class="p">}</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>    <span class="c1"># if the parent&#39;s fhirid is given, use it to reference the parent, else use the sampleid of the parent</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>            <span class="p">{</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>                <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>            <span class="p">}</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>    <span class="k">elif</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>            <span class="p">{</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            <span class="p">}</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="p">)</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">receiptdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;receivedTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">receiptdate</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>    <span class="k">return</span> <span class="n">entry</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">restype</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cxx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_bundle packs a list of entries into a fhir bundle.&quot;&quot;&quot;</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>    <span class="n">bundle</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;transaction&quot;</span><span class="p">,</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="s2">&quot;entry&quot;</span><span class="p">:</span> <span class="n">entries</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>    <span class="p">}</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>    <span class="c1"># set resource type to bundle for cxx3, to the specific type for cxx4</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>    <span class="k">if</span> <span class="n">cxx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="n">bundle</span><span class="p">[</span><span class="s2">&quot;resourceType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bundle&quot;</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>    <span class="k">elif</span> <span class="n">cxx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>        <span class="n">bundle</span><span class="p">[</span><span class="s2">&quot;resourceType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restype</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>    <span class="k">return</span> <span class="n">bundle</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_obs</span><span class="p">(</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="n">finding</span><span class="p">:</span><span class="n">Finding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>        <span class="n">fhirid</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="n">update_with_overwrite</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        <span class="n">delete</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>        
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a><span class="p">):</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_obs builds a fhir observation from Finding.&quot;&quot;&quot;</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>    <span class="k">if</span> <span class="n">finding</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error: no sample id&quot;</span><span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>        <span class="n">exit</span><span class="p">()</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>    <span class="c1"># if no fhirid given, generate</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    <span class="k">if</span> <span class="n">fhirid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="n">fhirid</span> <span class="o">=</span> <span class="n">genfhirid</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>    <span class="c1"># if delete is set to true, change method to delete</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>    <span class="n">fhirmethod</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span> <span class="c1"># write observation</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>    <span class="k">if</span> <span class="n">delete</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="n">fhirmethod</span> <span class="o">=</span> <span class="s2">&quot;DELETE&quot;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>              
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Observation/</span><span class="si">{</span><span class="n">fhirid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fhirmethod</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Observation/</span><span class="si">{</span><span class="n">fhirid</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>        <span class="p">},</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Observation&quot;</span><span class="p">,</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">fhirid</span><span class="p">),</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="p">{</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/updateWithOverwrite&quot;</span><span class="p">,</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>                <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="n">update_with_overwrite</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>            <span class="p">}</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>            <span class="p">],</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>                
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                    <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">methodname</span><span class="p">))</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                <span class="p">]</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>            <span class="p">},</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>            <span class="p">},</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>            <span class="s2">&quot;effectiveDateTime&quot;</span><span class="p">:</span> <span class="n">datestring</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">findingdate</span><span class="p">),</span> 
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                    <span class="p">{</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:centraxx&quot;</span><span class="p">,</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>                    <span class="p">}</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>                <span class="p">]</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>            <span class="p">},</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>            <span class="s2">&quot;specimen&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>            <span class="p">},</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="p">}</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>    <span class="p">}</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>    <span class="c1"># die messparameter landen in components</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">finding</span><span class="o">.</span><span class="n">recs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="c1"># don&#39;t put in empty values</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="k">if</span> <span class="n">rec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>            <span class="k">continue</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="n">comp</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>                    <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                <span class="p">]</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>            <span class="p">}</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>        <span class="p">}</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>        <span class="c1"># put something different depending on the type of the rec</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BooleanRec</span><span class="p">:</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueBoolean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">NumberRec</span><span class="p">:</span> <span class="c1"># are numbers always turned to quantities? # todo</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueQuantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                <span class="c1"># shouldn&#39;t NumberRec.value already be a float?</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># todo setting 0 is not right actually, cause the db returns NULL, but None isn&#39;t accepted by fhirimporter </span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="p">}</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="c1"># set the unit only if it is there</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;valueQuantity&quot;</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">:</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>                <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueQuantity&quot;</span><span class="p">][</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">unit</span> <span class="c1"># from laborvalue</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">StringRec</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueString&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>            <span class="c1"># somehow strings may not be empty or null, so don&#39;t add the component if that&#39;s the case? todo how to delete a string?</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                <span class="k">continue</span> <span class="c1"># continue without adding the component</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DateRec</span><span class="p">:</span> 
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueDateTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> 
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">MultiRec</span><span class="p">:</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>            <span class="c1"># collect the values </span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>                    <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:centraxx:CodeSystem/UsageEntry-x&quot;</span><span class="p">,</span> <span class="c1"># sometimes the x is oid, but doesn&#39;t seem to need to be</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>                    <span class="p">})</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>            <span class="c1"># put the collected values into the coding field of a value codeable concept</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueCodeableConcept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="n">a</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>            <span class="p">}</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">CatalogRec</span><span class="p">:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>            <span class="c1"># collect the values </span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>                    <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;urn:centraxx:CodeSystem/ValueList-</span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">catalog</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="c1"># here apparently the catalog code is needed</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>                    <span class="p">})</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="c1"># put the collected values into the coding field of a value codeable concept</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueCodeableConcept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="n">a</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>            <span class="p">}</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>            
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;component&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>    <span class="c1"># add the sender</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>    <span class="k">if</span> <span class="n">finding</span><span class="o">.</span><span class="n">sender</span><span class="p">:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;component&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>            <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>                <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;EINS_CODE&quot;</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>            <span class="p">]</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="p">},</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="s2">&quot;valueString&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>        <span class="p">})</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>    <span class="k">return</span> <span class="n">entry</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_patient</span><span class="p">(</span><span class="n">patient</span><span class="p">:</span><span class="n">Patient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_with_overwrite</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_patient baut einen patienten.&quot;&quot;&quot;</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>    <span class="c1"># if there isn&#39;t a fhirid, make it based on the patient&#39;s main id</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>    <span class="c1"># the fhirid needs to be unique for the patient, it is also written to the db and patient records can be updated with it</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>    <span class="n">fhirid</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s2">&quot;fhirid&quot;</span><span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>    <span class="k">if</span> <span class="n">fhirid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="n">fhirid</span> <span class="o">=</span> <span class="n">genfhirid</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Patient/</span><span class="si">{</span><span class="n">fhirid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">,</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">fhirid</span><span class="p">,</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/updateWithOverwrite&quot;</span><span class="p">,</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>                <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="n">update_with_overwrite</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>            <span class="p">}],</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>            <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># filled later</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>            <span class="s2">&quot;generalPractitioner&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">orga</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>                <span class="p">}</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>            <span class="p">}</span> <span class="p">]</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="p">},</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Patient/</span><span class="si">{</span><span class="n">fhirid</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>        <span class="p">}</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>    <span class="p">}</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">patient</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>        <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;oid&quot;</span> <span class="ow">and</span> <span class="nb">id</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;fhirid&quot;</span><span class="p">:</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>             <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_identifier</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>    
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>    <span class="k">return</span> <span class="n">entry</span>
</span></pre></div>


            </section>
                <section id="write_patients">
                            <input id="write_patients-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">write_patients</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">pats</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">batchsize</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">wrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">should_print</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">cxx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="write_patients-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#write_patients"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="write_patients-18"><a href="#write_patients-18"><span class="linenos">18</span></a><span class="k">def</span><span class="w"> </span><span class="nf">write_patients</span><span class="p">(</span><span class="n">pats</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">should_print</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cxx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="write_patients-19"><a href="#write_patients-19"><span class="linenos">19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;write_patients writes fhir resources of patients and returns a list containing the written directory.&quot;&quot;&quot;</span>
</span><span id="write_patients-20"><a href="#write_patients-20"><span class="linenos">20</span></a>
</span><span id="write_patients-21"><a href="#write_patients-21"><span class="linenos">21</span></a>    <span class="c1"># get the entries</span>
</span><span id="write_patients-22"><a href="#write_patients-22"><span class="linenos">22</span></a>    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="write_patients-23"><a href="#write_patients-23"><span class="linenos">23</span></a>    <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">pats</span><span class="p">:</span>
</span><span id="write_patients-24"><a href="#write_patients-24"><span class="linenos">24</span></a>        <span class="c1"># make a fhirid that depends on the limspsn, the fhirid is  </span>
</span><span id="write_patients-25"><a href="#write_patients-25"><span class="linenos">25</span></a>        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_patient</span><span class="p">(</span><span class="n">pat</span><span class="p">))</span>
</span><span id="write_patients-26"><a href="#write_patients-26"><span class="linenos">26</span></a>
</span><span id="write_patients-27"><a href="#write_patients-27"><span class="linenos">27</span></a>    <span class="c1"># bundles the entries </span>
</span><span id="write_patients-28"><a href="#write_patients-28"><span class="linenos">28</span></a>    <span class="n">bundles</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="s2">&quot;Patient&quot;</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="n">cxx</span><span class="p">)</span>
</span><span id="write_patients-29"><a href="#write_patients-29"><span class="linenos">29</span></a>
</span><span id="write_patients-30"><a href="#write_patients-30"><span class="linenos">30</span></a>    <span class="c1"># if print is set, print</span>
</span><span id="write_patients-31"><a href="#write_patients-31"><span class="linenos">31</span></a>    <span class="k">if</span> <span class="n">should_print</span><span class="p">:</span>
</span><span id="write_patients-32"><a href="#write_patients-32"><span class="linenos">32</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>    
</span><span id="write_patients-33"><a href="#write_patients-33"><span class="linenos">33</span></a>
</span><span id="write_patients-34"><a href="#write_patients-34"><span class="linenos">34</span></a>    <span class="c1"># write the bundles</span>
</span><span id="write_patients-35"><a href="#write_patients-35"><span class="linenos">35</span></a>    <span class="k">return</span> <span class="n">writeout</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="s2">&quot;patient&quot;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">wrap</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>write_patients writes fhir resources of patients and returns a list containing the written directory.</p>
</div>


                </section>
                <section id="write_samples">
                            <input id="write_samples-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">write_samples</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">samples</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">batchsize</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">wrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">should_print</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">cxx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="write_samples-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#write_samples"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="write_samples-37"><a href="#write_samples-37"><span class="linenos">37</span></a><span class="k">def</span><span class="w"> </span><span class="nf">write_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">should_print</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cxx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="write_samples-38"><a href="#write_samples-38"><span class="linenos">38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;write_samples writes fhir resources of Samples and returns a list containing the written directory.&quot;&quot;&quot;</span>
</span><span id="write_samples-39"><a href="#write_samples-39"><span class="linenos">39</span></a>
</span><span id="write_samples-40"><a href="#write_samples-40"><span class="linenos">40</span></a>    <span class="c1"># fill in fhirids, taking parent-child relations into account.</span>
</span><span id="write_samples-41"><a href="#write_samples-41"><span class="linenos">41</span></a>    <span class="n">_fill_in_fhirids</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="write_samples-42"><a href="#write_samples-42"><span class="linenos">42</span></a>
</span><span id="write_samples-43"><a href="#write_samples-43"><span class="linenos">43</span></a>    <span class="c1"># collect the entries</span>
</span><span id="write_samples-44"><a href="#write_samples-44"><span class="linenos">44</span></a>    <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
</span><span id="write_samples-45"><a href="#write_samples-45"><span class="linenos">45</span></a>    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
</span><span id="write_samples-46"><a href="#write_samples-46"><span class="linenos">46</span></a>        <span class="c1"># build aliquot group or standard sample</span>
</span><span id="write_samples-47"><a href="#write_samples-47"><span class="linenos">47</span></a>        <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;ALIQUOTGROUP&quot;</span><span class="p">:</span>
</span><span id="write_samples-48"><a href="#write_samples-48"><span class="linenos">48</span></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">fhir_aliquotgroup</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</span><span id="write_samples-49"><a href="#write_samples-49"><span class="linenos">49</span></a>        <span class="k">elif</span> <span class="n">sample</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;MASTER&quot;</span> <span class="ow">or</span> <span class="n">sample</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;DERIVED&quot;</span><span class="p">:</span>
</span><span id="write_samples-50"><a href="#write_samples-50"><span class="linenos">50</span></a>            <span class="n">entry</span> <span class="o">=</span> <span class="n">fhir_specimen</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</span><span id="write_samples-51"><a href="#write_samples-51"><span class="linenos">51</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="write_samples-52"><a href="#write_samples-52"><span class="linenos">52</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sample category </span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">category</span><span class="si">}</span><span class="s2"> is not allowed.&quot;</span><span class="p">)</span>
</span><span id="write_samples-53"><a href="#write_samples-53"><span class="linenos">53</span></a>
</span><span id="write_samples-54"><a href="#write_samples-54"><span class="linenos">54</span></a>        <span class="c1"># append the entry</span>
</span><span id="write_samples-55"><a href="#write_samples-55"><span class="linenos">55</span></a>        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span id="write_samples-56"><a href="#write_samples-56"><span class="linenos">56</span></a>
</span><span id="write_samples-57"><a href="#write_samples-57"><span class="linenos">57</span></a>
</span><span id="write_samples-58"><a href="#write_samples-58"><span class="linenos">58</span></a>
</span><span id="write_samples-59"><a href="#write_samples-59"><span class="linenos">59</span></a>    <span class="c1"># bundles the entries</span>
</span><span id="write_samples-60"><a href="#write_samples-60"><span class="linenos">60</span></a>    <span class="n">bundles</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="n">cxx</span><span class="p">)</span>
</span><span id="write_samples-61"><a href="#write_samples-61"><span class="linenos">61</span></a>
</span><span id="write_samples-62"><a href="#write_samples-62"><span class="linenos">62</span></a>    <span class="c1"># if print is set, print</span>
</span><span id="write_samples-63"><a href="#write_samples-63"><span class="linenos">63</span></a>    <span class="k">if</span> <span class="n">should_print</span><span class="p">:</span>
</span><span id="write_samples-64"><a href="#write_samples-64"><span class="linenos">64</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</span><span id="write_samples-65"><a href="#write_samples-65"><span class="linenos">65</span></a>        
</span><span id="write_samples-66"><a href="#write_samples-66"><span class="linenos">66</span></a>    <span class="c1"># write the bundles</span>
</span><span id="write_samples-67"><a href="#write_samples-67"><span class="linenos">67</span></a>    <span class="k">return</span> <span class="n">writeout</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">wrap</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>write_samples writes fhir resources of Samples and returns a list containing the written directory.</p>
</div>


                </section>
                <section id="write_observations">
                            <input id="write_observations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">write_observations</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">findings</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">batchsize</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">wrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">should_print</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">cxx</span><span class="o">=</span><span class="mi">3</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="write_observations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#write_observations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="write_observations-112"><a href="#write_observations-112"><span class="linenos">112</span></a><span class="k">def</span><span class="w"> </span><span class="nf">write_observations</span><span class="p">(</span><span class="n">findings</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">should_print</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="write_observations-113"><a href="#write_observations-113"><span class="linenos">113</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;write_observations writes fhir resources of observations and returns a list containing the written directory.&quot;&quot;&quot;</span> 
</span><span id="write_observations-114"><a href="#write_observations-114"><span class="linenos">114</span></a>
</span><span id="write_observations-115"><a href="#write_observations-115"><span class="linenos">115</span></a>    <span class="c1"># get the entries</span>
</span><span id="write_observations-116"><a href="#write_observations-116"><span class="linenos">116</span></a>    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="write_observations-117"><a href="#write_observations-117"><span class="linenos">117</span></a>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="write_observations-118"><a href="#write_observations-118"><span class="linenos">118</span></a>    <span class="k">for</span> <span class="n">finding</span> <span class="ow">in</span> <span class="n">findings</span><span class="p">:</span>
</span><span id="write_observations-119"><a href="#write_observations-119"><span class="linenos">119</span></a>        <span class="c1"># make a fhirid from sampleid and method code</span>
</span><span id="write_observations-120"><a href="#write_observations-120"><span class="linenos">120</span></a>        <span class="c1">#print(&quot;sampleid: &quot; + finding.sample.id())</span>
</span><span id="write_observations-121"><a href="#write_observations-121"><span class="linenos">121</span></a>        <span class="c1">#print(&quot;method: &quot; + finding.method)</span>
</span><span id="write_observations-122"><a href="#write_observations-122"><span class="linenos">122</span></a>        <span class="n">fhirid</span> <span class="o">=</span> <span class="n">genfhirid</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="o">+</span> <span class="n">finding</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</span><span id="write_observations-123"><a href="#write_observations-123"><span class="linenos">123</span></a>        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_obs</span><span class="p">(</span><span class="n">finding</span><span class="p">,</span> <span class="n">fhirid</span><span class="o">=</span><span class="n">fhirid</span><span class="p">))</span>
</span><span id="write_observations-124"><a href="#write_observations-124"><span class="linenos">124</span></a>        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="write_observations-125"><a href="#write_observations-125"><span class="linenos">125</span></a>
</span><span id="write_observations-126"><a href="#write_observations-126"><span class="linenos">126</span></a>    <span class="c1"># bundles the entries</span>
</span><span id="write_observations-127"><a href="#write_observations-127"><span class="linenos">127</span></a>    <span class="n">bundles</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">batchsize</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="s2">&quot;Observation&quot;</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="write_observations-128"><a href="#write_observations-128"><span class="linenos">128</span></a>
</span><span id="write_observations-129"><a href="#write_observations-129"><span class="linenos">129</span></a>    <span class="c1"># if print is set, print</span>
</span><span id="write_observations-130"><a href="#write_observations-130"><span class="linenos">130</span></a>    <span class="k">if</span> <span class="n">should_print</span><span class="p">:</span>
</span><span id="write_observations-131"><a href="#write_observations-131"><span class="linenos">131</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</span><span id="write_observations-132"><a href="#write_observations-132"><span class="linenos">132</span></a>
</span><span id="write_observations-133"><a href="#write_observations-133"><span class="linenos">133</span></a>    <span class="c1"># write the bundles</span>
</span><span id="write_observations-134"><a href="#write_observations-134"><span class="linenos">134</span></a>    <span class="k">return</span> <span class="n">writeout</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="n">wrap</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>write_observations writes fhir resources of observations and returns a list containing the written directory.</p>
</div>


                </section>
                <section id="bundle">
                            <input id="bundle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bundle</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">entries</span>, </span><span class="param"><span class="n">n</span>, </span><span class="param"><span class="n">restype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">cxx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="bundle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#bundle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="bundle-137"><a href="#bundle-137"><span class="linenos">137</span></a><span class="k">def</span><span class="w"> </span><span class="nf">bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">restype</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cxx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="bundle-138"><a href="#bundle-138"><span class="linenos">138</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;bundle puts n entries in a bundle each.&quot;&quot;&quot;</span>
</span><span id="bundle-139"><a href="#bundle-139"><span class="linenos">139</span></a>
</span><span id="bundle-140"><a href="#bundle-140"><span class="linenos">140</span></a>    <span class="n">bundles</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="bundle-141"><a href="#bundle-141"><span class="linenos">141</span></a>    <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="bundle-142"><a href="#bundle-142"><span class="linenos">142</span></a>
</span><span id="bundle-143"><a href="#bundle-143"><span class="linenos">143</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entries</span><span class="p">):</span>
</span><span id="bundle-144"><a href="#bundle-144"><span class="linenos">144</span></a>        <span class="c1"># after each n entries</span>
</span><span id="bundle-145"><a href="#bundle-145"><span class="linenos">145</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="bundle-146"><a href="#bundle-146"><span class="linenos">146</span></a>            <span class="c1"># append a bundle of the full batch</span>
</span><span id="bundle-147"><a href="#bundle-147"><span class="linenos">147</span></a>            <span class="n">bundles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_bundle</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="n">restype</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="n">cxx</span><span class="p">))</span>
</span><span id="bundle-148"><a href="#bundle-148"><span class="linenos">148</span></a>            <span class="c1"># reset the batch</span>
</span><span id="bundle-149"><a href="#bundle-149"><span class="linenos">149</span></a>            <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="bundle-150"><a href="#bundle-150"><span class="linenos">150</span></a>        <span class="c1"># add to the batch</span>
</span><span id="bundle-151"><a href="#bundle-151"><span class="linenos">151</span></a>        <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span id="bundle-152"><a href="#bundle-152"><span class="linenos">152</span></a>
</span><span id="bundle-153"><a href="#bundle-153"><span class="linenos">153</span></a>    <span class="c1"># append the last batch</span>
</span><span id="bundle-154"><a href="#bundle-154"><span class="linenos">154</span></a>    <span class="n">bundles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_bundle</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="n">restype</span><span class="p">,</span> <span class="n">cxx</span><span class="o">=</span><span class="n">cxx</span><span class="p">))</span>
</span><span id="bundle-155"><a href="#bundle-155"><span class="linenos">155</span></a>
</span><span id="bundle-156"><a href="#bundle-156"><span class="linenos">156</span></a>    <span class="k">return</span> <span class="n">bundles</span>
</span></pre></div>


            <div class="docstring"><p>bundle puts n entries in a bundle each.</p>
</div>


                </section>
                <section id="writeout">
                            <input id="writeout-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">writeout</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">bundles</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">wrap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="writeout-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#writeout"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="writeout-159"><a href="#writeout-159"><span class="linenos">159</span></a><span class="k">def</span><span class="w"> </span><span class="nf">writeout</span><span class="p">(</span><span class="n">bundles</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">wrap</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="writeout-160"><a href="#writeout-160"><span class="linenos">160</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;writeout writes fhir bundles into a directory as seperate files, wrapping them into a timestamped directory if wrap is True.&quot;&quot;&quot;</span>
</span><span id="writeout-161"><a href="#writeout-161"><span class="linenos">161</span></a>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M-%S&quot;</span><span class="p">)</span>
</span><span id="writeout-162"><a href="#writeout-162"><span class="linenos">162</span></a>
</span><span id="writeout-163"><a href="#writeout-163"><span class="linenos">163</span></a>    <span class="c1"># wrap the output into a timestamped directory if wished</span>
</span><span id="writeout-164"><a href="#writeout-164"><span class="linenos">164</span></a>    <span class="n">outdir</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="writeout-165"><a href="#writeout-165"><span class="linenos">165</span></a>    <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
</span><span id="writeout-166"><a href="#writeout-166"><span class="linenos">166</span></a>        <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
</span><span id="writeout-167"><a href="#writeout-167"><span class="linenos">167</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="writeout-168"><a href="#writeout-168"><span class="linenos">168</span></a>        <span class="n">outdir</span> <span class="o">=</span> <span class="nb">dir</span>
</span><span id="writeout-169"><a href="#writeout-169"><span class="linenos">169</span></a>
</span><span id="writeout-170"><a href="#writeout-170"><span class="linenos">170</span></a>    <span class="c1"># create the output directory</span>
</span><span id="writeout-171"><a href="#writeout-171"><span class="linenos">171</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
</span><span id="writeout-172"><a href="#writeout-172"><span class="linenos">172</span></a>    
</span><span id="writeout-173"><a href="#writeout-173"><span class="linenos">173</span></a>    <span class="c1"># how broad should the zero-place holder for the pagenumber in the filenames be? (eg for 999 pages 3, for 1000 pages 4)</span>
</span><span id="writeout-174"><a href="#writeout-174"><span class="linenos">174</span></a>    <span class="n">page_num_width</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bundles</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="writeout-175"><a href="#writeout-175"><span class="linenos">175</span></a>
</span><span id="writeout-176"><a href="#writeout-176"><span class="linenos">176</span></a>    <span class="c1"># write each bundle in a seperate file, using the same timestamp and increasing page numbers.</span>
</span><span id="writeout-177"><a href="#writeout-177"><span class="linenos">177</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bundle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bundles</span><span class="p">):</span>
</span><span id="writeout-178"><a href="#writeout-178"><span class="linenos">178</span></a>        <span class="n">fstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_p%0&quot;</span> <span class="o">+</span> <span class="n">page_num_width</span> <span class="o">+</span> <span class="s2">&quot;d.json&quot;</span>
</span><span id="writeout-179"><a href="#writeout-179"><span class="linenos">179</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">fstring</span> <span class="o">%</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span><span id="writeout-180"><a href="#writeout-180"><span class="linenos">180</span></a>        <span class="c1"># filename = timestamp + &quot;_&quot; + type + &quot;_p&quot; + str(i) + &quot;.json&quot;</span>
</span><span id="writeout-181"><a href="#writeout-181"><span class="linenos">181</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="writeout-182"><a href="#writeout-182"><span class="linenos">182</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
</span><span id="writeout-183"><a href="#writeout-183"><span class="linenos">183</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">outf</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="writeout-184"><a href="#writeout-184"><span class="linenos">184</span></a>
</span><span id="writeout-185"><a href="#writeout-185"><span class="linenos">185</span></a>    <span class="c1"># for now, only return the directory path, not the paths of the written files</span>
</span><span id="writeout-186"><a href="#writeout-186"><span class="linenos">186</span></a>    <span class="k">return</span> <span class="p">[</span><span class="n">outdir</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>writeout writes fhir bundles into a directory as seperate files, wrapping them into a timestamped directory if wrap is True.</p>
</div>


                </section>
                <section id="fhir_identifier">
                            <input id="fhir_identifier-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_identifier</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">identifier</span><span class="p">:</span> <span class="n">tram</span><span class="o">.</span><span class="n">Identifier</span>, </span><span class="param"><span class="n">system</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;urn:centraxx&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_identifier-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_identifier"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_identifier-190"><a href="#fhir_identifier-190"><span class="linenos">190</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_identifier</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span><span class="n">Identifier</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;urn:centraxx&quot;</span><span class="p">):</span>
</span><span id="fhir_identifier-191"><a href="#fhir_identifier-191"><span class="linenos">191</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; fhirIdentifier returns a fhir identifier.&quot;&quot;&quot;</span>
</span><span id="fhir_identifier-192"><a href="#fhir_identifier-192"><span class="linenos">192</span></a>
</span><span id="fhir_identifier-193"><a href="#fhir_identifier-193"><span class="linenos">193</span></a>    <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_identifier-194"><a href="#fhir_identifier-194"><span class="linenos">194</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="fhir_identifier-195"><a href="#fhir_identifier-195"><span class="linenos">195</span></a>    <span class="k">if</span> <span class="n">identifier</span><span class="o">.</span><span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_identifier-196"><a href="#fhir_identifier-196"><span class="linenos">196</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;identifier or code for fhir identifier is None&quot;</span><span class="p">)</span>
</span><span id="fhir_identifier-197"><a href="#fhir_identifier-197"><span class="linenos">197</span></a>
</span><span id="fhir_identifier-198"><a href="#fhir_identifier-198"><span class="linenos">198</span></a>    <span class="nb">id</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">id</span>
</span><span id="fhir_identifier-199"><a href="#fhir_identifier-199"><span class="linenos">199</span></a>    <span class="c1"># why also exclude &#39;NULL&#39;?    </span>
</span><span id="fhir_identifier-200"><a href="#fhir_identifier-200"><span class="linenos">200</span></a>    <span class="c1">#if  id is None or id == &quot;&quot; or id == &quot;NULL&quot;:</span>
</span><span id="fhir_identifier-201"><a href="#fhir_identifier-201"><span class="linenos">201</span></a>    <span class="c1"># why error on missing values? is it because fhirimport doesn&#39;t take no null values? but that&#39;s not quite in the scope of fhirbuild to know, is it?</span>
</span><span id="fhir_identifier-202"><a href="#fhir_identifier-202"><span class="linenos">202</span></a>    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>    
</span><span id="fhir_identifier-203"><a href="#fhir_identifier-203"><span class="linenos">203</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;id for fhir identifier </span><span class="si">{</span><span class="n">identifier</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2"> is &#39;</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="fhir_identifier-204"><a href="#fhir_identifier-204"><span class="linenos">204</span></a>    
</span><span id="fhir_identifier-205"><a href="#fhir_identifier-205"><span class="linenos">205</span></a>    <span class="c1"># set the id to None if &#39;NULL&#39; was given? </span>
</span><span id="fhir_identifier-206"><a href="#fhir_identifier-206"><span class="linenos">206</span></a>    <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
</span><span id="fhir_identifier-207"><a href="#fhir_identifier-207"><span class="linenos">207</span></a>        <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="fhir_identifier-208"><a href="#fhir_identifier-208"><span class="linenos">208</span></a>        
</span><span id="fhir_identifier-209"><a href="#fhir_identifier-209"><span class="linenos">209</span></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="fhir_identifier-210"><a href="#fhir_identifier-210"><span class="linenos">210</span></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_identifier-211"><a href="#fhir_identifier-211"><span class="linenos">211</span></a>            <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_identifier-212"><a href="#fhir_identifier-212"><span class="linenos">212</span></a>                <span class="n">fhir_coding</span><span class="p">(</span><span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">identifier</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
</span><span id="fhir_identifier-213"><a href="#fhir_identifier-213"><span class="linenos">213</span></a>            <span class="p">]</span>
</span><span id="fhir_identifier-214"><a href="#fhir_identifier-214"><span class="linenos">214</span></a>        <span class="p">},</span>
</span><span id="fhir_identifier-215"><a href="#fhir_identifier-215"><span class="linenos">215</span></a>        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">identifier</span><span class="o">.</span><span class="n">id</span>
</span><span id="fhir_identifier-216"><a href="#fhir_identifier-216"><span class="linenos">216</span></a>    <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>fhirIdentifier returns a fhir identifier.</p>
</div>


                </section>
                <section id="fhir_coding">
                            <input id="fhir_coding-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_coding</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">system</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;urn:centraxx&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_coding-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_coding"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_coding-218"><a href="#fhir_coding-218"><span class="linenos">218</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;urn:centraxx&quot;</span><span class="p">):</span>
</span><span id="fhir_coding-219"><a href="#fhir_coding-219"><span class="linenos">219</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_coding returns a fhir coding with code and system.&quot;&quot;&quot;</span>
</span><span id="fhir_coding-220"><a href="#fhir_coding-220"><span class="linenos">220</span></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="fhir_coding-221"><a href="#fhir_coding-221"><span class="linenos">221</span></a>        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">system</span><span class="p">,</span>
</span><span id="fhir_coding-222"><a href="#fhir_coding-222"><span class="linenos">222</span></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">code</span>
</span><span id="fhir_coding-223"><a href="#fhir_coding-223"><span class="linenos">223</span></a>    <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>fhir_coding returns a fhir coding with code and system.</p>
</div>


                </section>
                <section id="fhir_extension">
                            <input id="fhir_extension-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_extension</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">url</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">d</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_extension-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_extension"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_extension-225"><a href="#fhir_extension-225"><span class="linenos">225</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_extension</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="fhir_extension-226"><a href="#fhir_extension-226"><span class="linenos">226</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_extension returns a extension with url and puts everything from dict d in it.&quot;&quot;&quot;</span>
</span><span id="fhir_extension-227"><a href="#fhir_extension-227"><span class="linenos">227</span></a>    <span class="n">ext</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
</span><span id="fhir_extension-228"><a href="#fhir_extension-228"><span class="linenos">228</span></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
</span><span id="fhir_extension-229"><a href="#fhir_extension-229"><span class="linenos">229</span></a>        <span class="n">ext</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="fhir_extension-230"><a href="#fhir_extension-230"><span class="linenos">230</span></a>    <span class="k">return</span> <span class="n">ext</span>
</span></pre></div>


            <div class="docstring"><p>fhir_extension returns a extension with url and puts everything from dict d in it.</p>
</div>


                </section>
                <section id="fhir_specimen">
                            <input id="fhir_specimen-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_specimen</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sample</span><span class="p">:</span> <span class="n">tram</span><span class="o">.</span><span class="n">Sample</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">update_with_overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_specimen-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_specimen"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_specimen-233"><a href="#fhir_specimen-233"><span class="linenos">233</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_specimen</span><span class="p">(</span><span class="n">sample</span><span class="p">:</span><span class="n">Sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="fhir_specimen-234"><a href="#fhir_specimen-234"><span class="linenos">234</span></a>                <span class="n">update_with_overwrite</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span> 
</span><span id="fhir_specimen-235"><a href="#fhir_specimen-235"><span class="linenos">235</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_specimen builds a fhir specimen. pass the sample&#39;s fhirid as an Identifier with code &quot;fhirid&quot; for the sample, and, for deriveds, the fhirid of its parent aliquotgroup as an Identifier with code &quot;fhirid&quot; of sample.parent. by tying the fhirids directly to the sample, calling methods can receive fhirids for lists of Samples e.g. from csv without having to sneak them in via an extra argument.&quot;&quot;&quot;</span>
</span><span id="fhir_specimen-236"><a href="#fhir_specimen-236"><span class="linenos">236</span></a>
</span><span id="fhir_specimen-237"><a href="#fhir_specimen-237"><span class="linenos">237</span></a>    <span class="c1"># todo also build aliquotgroups?</span>
</span><span id="fhir_specimen-238"><a href="#fhir_specimen-238"><span class="linenos">238</span></a>    
</span><span id="fhir_specimen-239"><a href="#fhir_specimen-239"><span class="linenos">239</span></a>    <span class="c1"># print(f&quot;fhir_specimen: {sample.category} {fhirid} {sample.collected_date} {sample.xposition} {sample.yposition}&quot;)</span>
</span><span id="fhir_specimen-240"><a href="#fhir_specimen-240"><span class="linenos">240</span></a>    
</span><span id="fhir_specimen-241"><a href="#fhir_specimen-241"><span class="linenos">241</span></a>    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_specimen-242"><a href="#fhir_specimen-242"><span class="linenos">242</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-243"><a href="#fhir_specimen-243"><span class="linenos">243</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_specimen-244"><a href="#fhir_specimen-244"><span class="linenos">244</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Specimen&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-245"><a href="#fhir_specimen-245"><span class="linenos">245</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-246"><a href="#fhir_specimen-246"><span class="linenos">246</span></a>            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_specimen-247"><a href="#fhir_specimen-247"><span class="linenos">247</span></a>                <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-248"><a href="#fhir_specimen-248"><span class="linenos">248</span></a>                    <span class="s2">&quot;https://fhir.centraxx.de/extension/updateWithOverwrite&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-249"><a href="#fhir_specimen-249"><span class="linenos">249</span></a>                    <span class="p">{</span> <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="n">update_with_overwrite</span> <span class="p">}</span>
</span><span id="fhir_specimen-250"><a href="#fhir_specimen-250"><span class="linenos">250</span></a>                <span class="p">),</span>
</span><span id="fhir_specimen-251"><a href="#fhir_specimen-251"><span class="linenos">251</span></a>                <span class="c1"># reposition date added later</span>
</span><span id="fhir_specimen-252"><a href="#fhir_specimen-252"><span class="linenos">252</span></a>                <span class="c1"># location path added later</span>
</span><span id="fhir_specimen-253"><a href="#fhir_specimen-253"><span class="linenos">253</span></a>                <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-254"><a href="#fhir_specimen-254"><span class="linenos">254</span></a>                    <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/organizationUnit&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-255"><a href="#fhir_specimen-255"><span class="linenos">255</span></a>                    <span class="p">{</span>
</span><span id="fhir_specimen-256"><a href="#fhir_specimen-256"><span class="linenos">256</span></a>                        <span class="s2">&quot;valueReference&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_specimen-257"><a href="#fhir_specimen-257"><span class="linenos">257</span></a>                        <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_specimen-258"><a href="#fhir_specimen-258"><span class="linenos">258</span></a>                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">orga</span><span class="p">)</span>
</span><span id="fhir_specimen-259"><a href="#fhir_specimen-259"><span class="linenos">259</span></a>                        <span class="p">}</span>
</span><span id="fhir_specimen-260"><a href="#fhir_specimen-260"><span class="linenos">260</span></a>                    <span class="p">}</span>
</span><span id="fhir_specimen-261"><a href="#fhir_specimen-261"><span class="linenos">261</span></a>                <span class="p">}),</span>
</span><span id="fhir_specimen-262"><a href="#fhir_specimen-262"><span class="linenos">262</span></a>                <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-263"><a href="#fhir_specimen-263"><span class="linenos">263</span></a>                    <span class="s2">&quot;https://fhir.centraxx.de/extension/sampleCategory&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-264"><a href="#fhir_specimen-264"><span class="linenos">264</span></a>                    <span class="p">{</span>
</span><span id="fhir_specimen-265"><a href="#fhir_specimen-265"><span class="linenos">265</span></a>                        <span class="s2">&quot;valueCoding&quot;</span><span class="p">:</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">category</span><span class="p">))</span> 
</span><span id="fhir_specimen-266"><a href="#fhir_specimen-266"><span class="linenos">266</span></a>                    <span class="p">}</span>
</span><span id="fhir_specimen-267"><a href="#fhir_specimen-267"><span class="linenos">267</span></a>                <span class="p">)</span>
</span><span id="fhir_specimen-268"><a href="#fhir_specimen-268"><span class="linenos">268</span></a>            <span class="p">],</span>
</span><span id="fhir_specimen-269"><a href="#fhir_specimen-269"><span class="linenos">269</span></a>            <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># filled later</span>
</span><span id="fhir_specimen-270"><a href="#fhir_specimen-270"><span class="linenos">270</span></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;available&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-271"><a href="#fhir_specimen-271"><span class="linenos">271</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_specimen-272"><a href="#fhir_specimen-272"><span class="linenos">272</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_specimen-273"><a href="#fhir_specimen-273"><span class="linenos">273</span></a>                    <span class="c1"># type (material) added later</span>
</span><span id="fhir_specimen-274"><a href="#fhir_specimen-274"><span class="linenos">274</span></a>                <span class="p">]</span>
</span><span id="fhir_specimen-275"><a href="#fhir_specimen-275"><span class="linenos">275</span></a>            <span class="p">},</span>
</span><span id="fhir_specimen-276"><a href="#fhir_specimen-276"><span class="linenos">276</span></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_specimen-277"><a href="#fhir_specimen-277"><span class="linenos">277</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="fhir_specimen-278"><a href="#fhir_specimen-278"><span class="linenos">278</span></a>            <span class="p">},</span>
</span><span id="fhir_specimen-279"><a href="#fhir_specimen-279"><span class="linenos">279</span></a>            <span class="c1"># &quot;receivedTime&quot;: # added later</span>
</span><span id="fhir_specimen-280"><a href="#fhir_specimen-280"><span class="linenos">280</span></a>            <span class="c1"># &quot;parent&quot;: [ ], # filled later</span>
</span><span id="fhir_specimen-281"><a href="#fhir_specimen-281"><span class="linenos">281</span></a>            <span class="s2">&quot;collection&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_specimen-282"><a href="#fhir_specimen-282"><span class="linenos">282</span></a>                <span class="c1"># &quot;collectedDateTime&quot;: collected_date, # added later</span>
</span><span id="fhir_specimen-283"><a href="#fhir_specimen-283"><span class="linenos">283</span></a>                <span class="c1"># &quot;quantity&quot;: initial_amount # added later</span>
</span><span id="fhir_specimen-284"><a href="#fhir_specimen-284"><span class="linenos">284</span></a>            <span class="p">},</span>
</span><span id="fhir_specimen-285"><a href="#fhir_specimen-285"><span class="linenos">285</span></a>            <span class="s2">&quot;container&quot;</span><span class="p">:</span> <span class="p">[</span> 
</span><span id="fhir_specimen-286"><a href="#fhir_specimen-286"><span class="linenos">286</span></a>                <span class="p">{</span>
</span><span id="fhir_specimen-287"><a href="#fhir_specimen-287"><span class="linenos">287</span></a>                    <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_specimen-288"><a href="#fhir_specimen-288"><span class="linenos">288</span></a>                        <span class="p">{</span>
</span><span id="fhir_specimen-289"><a href="#fhir_specimen-289"><span class="linenos">289</span></a>                            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:centraxx&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-290"><a href="#fhir_specimen-290"><span class="linenos">290</span></a>                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">receptacle</span><span class="p">)</span>
</span><span id="fhir_specimen-291"><a href="#fhir_specimen-291"><span class="linenos">291</span></a>                        <span class="p">}</span>
</span><span id="fhir_specimen-292"><a href="#fhir_specimen-292"><span class="linenos">292</span></a>                    <span class="p">],</span>
</span><span id="fhir_specimen-293"><a href="#fhir_specimen-293"><span class="linenos">293</span></a>                    <span class="c1"># &quot;capacity&quot;: capacity, # wird nicht gesetzt, hat keinen einfluss auf cxx</span>
</span><span id="fhir_specimen-294"><a href="#fhir_specimen-294"><span class="linenos">294</span></a>                    <span class="c1"># &quot;specimenQuantity&quot;: # is restamount, added later</span>
</span><span id="fhir_specimen-295"><a href="#fhir_specimen-295"><span class="linenos">295</span></a>                <span class="p">}</span>
</span><span id="fhir_specimen-296"><a href="#fhir_specimen-296"><span class="linenos">296</span></a>            <span class="p">]</span>
</span><span id="fhir_specimen-297"><a href="#fhir_specimen-297"><span class="linenos">297</span></a>        <span class="p">},</span>
</span><span id="fhir_specimen-298"><a href="#fhir_specimen-298"><span class="linenos">298</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_specimen-299"><a href="#fhir_specimen-299"><span class="linenos">299</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-300"><a href="#fhir_specimen-300"><span class="linenos">300</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-301"><a href="#fhir_specimen-301"><span class="linenos">301</span></a>        <span class="p">}</span>
</span><span id="fhir_specimen-302"><a href="#fhir_specimen-302"><span class="linenos">302</span></a>    <span class="p">}</span>
</span><span id="fhir_specimen-303"><a href="#fhir_specimen-303"><span class="linenos">303</span></a>
</span><span id="fhir_specimen-304"><a href="#fhir_specimen-304"><span class="linenos">304</span></a>    <span class="c1"># fill the identifiers.  skip the oid for now</span>
</span><span id="fhir_specimen-305"><a href="#fhir_specimen-305"><span class="linenos">305</span></a>    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">sample</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
</span><span id="fhir_specimen-306"><a href="#fhir_specimen-306"><span class="linenos">306</span></a>         <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;oid&quot;</span> <span class="ow">and</span> <span class="nb">id</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;fhirid&quot;</span><span class="p">:</span>
</span><span id="fhir_specimen-307"><a href="#fhir_specimen-307"><span class="linenos">307</span></a>             <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_identifier</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
</span><span id="fhir_specimen-308"><a href="#fhir_specimen-308"><span class="linenos">308</span></a>    
</span><span id="fhir_specimen-309"><a href="#fhir_specimen-309"><span class="linenos">309</span></a>    <span class="c1"># bundle the values that end up in the sprec extension</span>
</span><span id="fhir_specimen-310"><a href="#fhir_specimen-310"><span class="linenos">310</span></a>
</span><span id="fhir_specimen-311"><a href="#fhir_specimen-311"><span class="linenos">311</span></a>    <span class="n">sprecext</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_specimen-312"><a href="#fhir_specimen-312"><span class="linenos">312</span></a>        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-313"><a href="#fhir_specimen-313"><span class="linenos">313</span></a>        <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_specimen-314"><a href="#fhir_specimen-314"><span class="linenos">314</span></a>            <span class="p">{</span>
</span><span id="fhir_specimen-315"><a href="#fhir_specimen-315"><span class="linenos">315</span></a>                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/useSprec&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-316"><a href="#fhir_specimen-316"><span class="linenos">316</span></a>                <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="fhir_specimen-317"><a href="#fhir_specimen-317"><span class="linenos">317</span></a>            <span class="p">}</span>
</span><span id="fhir_specimen-318"><a href="#fhir_specimen-318"><span class="linenos">318</span></a>        <span class="p">]</span>
</span><span id="fhir_specimen-319"><a href="#fhir_specimen-319"><span class="linenos">319</span></a>    <span class="p">}</span>
</span><span id="fhir_specimen-320"><a href="#fhir_specimen-320"><span class="linenos">320</span></a>
</span><span id="fhir_specimen-321"><a href="#fhir_specimen-321"><span class="linenos">321</span></a>    <span class="c1"># none checks for values.</span>
</span><span id="fhir_specimen-322"><a href="#fhir_specimen-322"><span class="linenos">322</span></a>    <span class="c1"># the fhir importer apparently doesn&#39;t import null values, so only put in values if they aren&#39;t none.</span>
</span><span id="fhir_specimen-323"><a href="#fhir_specimen-323"><span class="linenos">323</span></a>    <span class="c1"># this would make deleting values impossible at the moment.</span>
</span><span id="fhir_specimen-324"><a href="#fhir_specimen-324"><span class="linenos">324</span></a>    <span class="c1"># does cxx4 fhir import accept null values?</span>
</span><span id="fhir_specimen-325"><a href="#fhir_specimen-325"><span class="linenos">325</span></a>
</span><span id="fhir_specimen-326"><a href="#fhir_specimen-326"><span class="linenos">326</span></a>
</span><span id="fhir_specimen-327"><a href="#fhir_specimen-327"><span class="linenos">327</span></a>    <span class="c1"># first stock processing (centrifugation)</span>
</span><span id="fhir_specimen-328"><a href="#fhir_specimen-328"><span class="linenos">328</span></a>    
</span><span id="fhir_specimen-329"><a href="#fhir_specimen-329"><span class="linenos">329</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">stockprocessing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-330"><a href="#fhir_specimen-330"><span class="linenos">330</span></a>        <span class="c1"># append the stock processing sprec</span>
</span><span id="fhir_specimen-331"><a href="#fhir_specimen-331"><span class="linenos">331</span></a>        <span class="n">sprecext</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-332"><a href="#fhir_specimen-332"><span class="linenos">332</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/stockProcessing&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-333"><a href="#fhir_specimen-333"><span class="linenos">333</span></a>            <span class="p">{</span> <span class="s2">&quot;valueCoding&quot;</span><span class="p">:</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">stockprocessing</span><span class="p">)</span> <span class="p">}</span>
</span><span id="fhir_specimen-334"><a href="#fhir_specimen-334"><span class="linenos">334</span></a>        <span class="p">))</span>
</span><span id="fhir_specimen-335"><a href="#fhir_specimen-335"><span class="linenos">335</span></a>
</span><span id="fhir_specimen-336"><a href="#fhir_specimen-336"><span class="linenos">336</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">stockprocessingdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-337"><a href="#fhir_specimen-337"><span class="linenos">337</span></a>        <span class="c1"># append the stock processing date sprec</span>
</span><span id="fhir_specimen-338"><a href="#fhir_specimen-338"><span class="linenos">338</span></a>        <span class="n">sprecext</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-339"><a href="#fhir_specimen-339"><span class="linenos">339</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/stockProcessingDate&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-340"><a href="#fhir_specimen-340"><span class="linenos">340</span></a>            <span class="p">{</span> <span class="s2">&quot;valueDateTime&quot;</span><span class="p">:</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">stockprocessingdate</span><span class="p">)</span> <span class="p">}</span>
</span><span id="fhir_specimen-341"><a href="#fhir_specimen-341"><span class="linenos">341</span></a>        <span class="p">))</span>
</span><span id="fhir_specimen-342"><a href="#fhir_specimen-342"><span class="linenos">342</span></a>
</span><span id="fhir_specimen-343"><a href="#fhir_specimen-343"><span class="linenos">343</span></a>    <span class="c1"># second stock processing (centrifugation)</span>
</span><span id="fhir_specimen-344"><a href="#fhir_specimen-344"><span class="linenos">344</span></a>    
</span><span id="fhir_specimen-345"><a href="#fhir_specimen-345"><span class="linenos">345</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">secondprocessing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-346"><a href="#fhir_specimen-346"><span class="linenos">346</span></a>        <span class="c1"># append the second processing sprec</span>
</span><span id="fhir_specimen-347"><a href="#fhir_specimen-347"><span class="linenos">347</span></a>        <span class="n">sprecext</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-348"><a href="#fhir_specimen-348"><span class="linenos">348</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/secondProcessing&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-349"><a href="#fhir_specimen-349"><span class="linenos">349</span></a>            <span class="p">{</span> <span class="s2">&quot;valueCoding&quot;</span><span class="p">:</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">secondprocessing</span><span class="p">)</span> <span class="p">}</span>
</span><span id="fhir_specimen-350"><a href="#fhir_specimen-350"><span class="linenos">350</span></a>        <span class="p">))</span>
</span><span id="fhir_specimen-351"><a href="#fhir_specimen-351"><span class="linenos">351</span></a>
</span><span id="fhir_specimen-352"><a href="#fhir_specimen-352"><span class="linenos">352</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">secondprocessingdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-353"><a href="#fhir_specimen-353"><span class="linenos">353</span></a>        <span class="c1"># append the second processing date sprec</span>
</span><span id="fhir_specimen-354"><a href="#fhir_specimen-354"><span class="linenos">354</span></a>        <span class="n">sprecext</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-355"><a href="#fhir_specimen-355"><span class="linenos">355</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/secondProcessingDate&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-356"><a href="#fhir_specimen-356"><span class="linenos">356</span></a>            <span class="p">{</span> <span class="s2">&quot;valueDateTime&quot;</span><span class="p">:</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">secondprocessingdate</span><span class="p">)</span> <span class="p">}</span>
</span><span id="fhir_specimen-357"><a href="#fhir_specimen-357"><span class="linenos">357</span></a>        <span class="p">))</span>
</span><span id="fhir_specimen-358"><a href="#fhir_specimen-358"><span class="linenos">358</span></a>        
</span><span id="fhir_specimen-359"><a href="#fhir_specimen-359"><span class="linenos">359</span></a>                
</span><span id="fhir_specimen-360"><a href="#fhir_specimen-360"><span class="linenos">360</span></a>    <span class="c1"># add the sprec extension to the extensions</span>
</span><span id="fhir_specimen-361"><a href="#fhir_specimen-361"><span class="linenos">361</span></a>    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sprecext</span><span class="p">)</span>
</span><span id="fhir_specimen-362"><a href="#fhir_specimen-362"><span class="linenos">362</span></a>
</span><span id="fhir_specimen-363"><a href="#fhir_specimen-363"><span class="linenos">363</span></a>
</span><span id="fhir_specimen-364"><a href="#fhir_specimen-364"><span class="linenos">364</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">locationpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-365"><a href="#fhir_specimen-365"><span class="linenos">365</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="fhir_specimen-366"><a href="#fhir_specimen-366"><span class="linenos">366</span></a>            <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-367"><a href="#fhir_specimen-367"><span class="linenos">367</span></a>                    <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/sampleLocation&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-368"><a href="#fhir_specimen-368"><span class="linenos">368</span></a>                    <span class="p">{</span> <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_specimen-369"><a href="#fhir_specimen-369"><span class="linenos">369</span></a>                        <span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-370"><a href="#fhir_specimen-370"><span class="linenos">370</span></a>                            <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/sampleLocationPath&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-371"><a href="#fhir_specimen-371"><span class="linenos">371</span></a>                            <span class="p">{</span><span class="s2">&quot;valueString&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">locationpath</span><span class="p">)</span> <span class="p">}</span>
</span><span id="fhir_specimen-372"><a href="#fhir_specimen-372"><span class="linenos">372</span></a>                        <span class="p">)</span>
</span><span id="fhir_specimen-373"><a href="#fhir_specimen-373"><span class="linenos">373</span></a>                    <span class="p">]}</span>
</span><span id="fhir_specimen-374"><a href="#fhir_specimen-374"><span class="linenos">374</span></a>                <span class="p">)</span>
</span><span id="fhir_specimen-375"><a href="#fhir_specimen-375"><span class="linenos">375</span></a>        <span class="p">)</span>
</span><span id="fhir_specimen-376"><a href="#fhir_specimen-376"><span class="linenos">376</span></a>
</span><span id="fhir_specimen-377"><a href="#fhir_specimen-377"><span class="linenos">377</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">derivaldate</span><span class="p">:</span>
</span><span id="fhir_specimen-378"><a href="#fhir_specimen-378"><span class="linenos">378</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-379"><a href="#fhir_specimen-379"><span class="linenos">379</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/derivalDate&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-380"><a href="#fhir_specimen-380"><span class="linenos">380</span></a>            <span class="p">{</span> <span class="s2">&quot;valueDateTime&quot;</span><span class="p">:</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">derivaldate</span><span class="p">)</span> <span class="p">}</span>
</span><span id="fhir_specimen-381"><a href="#fhir_specimen-381"><span class="linenos">381</span></a>        <span class="p">))</span>
</span><span id="fhir_specimen-382"><a href="#fhir_specimen-382"><span class="linenos">382</span></a>
</span><span id="fhir_specimen-383"><a href="#fhir_specimen-383"><span class="linenos">383</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">xposition</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-384"><a href="#fhir_specimen-384"><span class="linenos">384</span></a>        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="s1">&#39;extension&#39;</span><span class="p">]:</span>
</span><span id="fhir_specimen-385"><a href="#fhir_specimen-385"><span class="linenos">385</span></a>
</span><span id="fhir_specimen-386"><a href="#fhir_specimen-386"><span class="linenos">386</span></a>            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/sampleLocation&quot;</span><span class="p">:</span>
</span><span id="fhir_specimen-387"><a href="#fhir_specimen-387"><span class="linenos">387</span></a>                <span class="c1"># fge xpos am Anfang ein</span>
</span><span id="fhir_specimen-388"><a href="#fhir_specimen-388"><span class="linenos">388</span></a>                <span class="c1"># print(f&quot;xpos found, inserting xposition {xposition}&quot;)</span>
</span><span id="fhir_specimen-389"><a href="#fhir_specimen-389"><span class="linenos">389</span></a>                <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;extension&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fhir_extension</span><span class="p">(</span><span class="s2">&quot;https://fhir.centraxx.de/extension/sample/xPosition&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;valueInteger&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">xposition</span><span class="p">)</span> <span class="p">}))</span> 
</span><span id="fhir_specimen-390"><a href="#fhir_specimen-390"><span class="linenos">390</span></a>
</span><span id="fhir_specimen-391"><a href="#fhir_specimen-391"><span class="linenos">391</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">yposition</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-392"><a href="#fhir_specimen-392"><span class="linenos">392</span></a>        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="s1">&#39;extension&#39;</span><span class="p">]:</span>
</span><span id="fhir_specimen-393"><a href="#fhir_specimen-393"><span class="linenos">393</span></a>            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/sampleLocation&quot;</span><span class="p">:</span>
</span><span id="fhir_specimen-394"><a href="#fhir_specimen-394"><span class="linenos">394</span></a>                <span class="c1"># fge ypos als zweites ein</span>
</span><span id="fhir_specimen-395"><a href="#fhir_specimen-395"><span class="linenos">395</span></a>                <span class="c1"># print(f&quot;ypos found, inserting yposition {yposition}&quot;)</span>
</span><span id="fhir_specimen-396"><a href="#fhir_specimen-396"><span class="linenos">396</span></a>                <span class="n">ext</span><span class="p">[</span><span class="s1">&#39;extension&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fhir_extension</span><span class="p">(</span><span class="s2">&quot;https://fhir.centraxx.de/extension/sample/yPosition&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;valueInteger&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">yposition</span><span class="p">)</span> <span class="p">}))</span> 
</span><span id="fhir_specimen-397"><a href="#fhir_specimen-397"><span class="linenos">397</span></a>
</span><span id="fhir_specimen-398"><a href="#fhir_specimen-398"><span class="linenos">398</span></a>
</span><span id="fhir_specimen-399"><a href="#fhir_specimen-399"><span class="linenos">399</span></a>    <span class="c1"># if the parent&#39;s fhirid is given, use it to reference the parent, else use the sampleid of the parent.</span>
</span><span id="fhir_specimen-400"><a href="#fhir_specimen-400"><span class="linenos">400</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-401"><a href="#fhir_specimen-401"><span class="linenos">401</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="fhir_specimen-402"><a href="#fhir_specimen-402"><span class="linenos">402</span></a>
</span><span id="fhir_specimen-403"><a href="#fhir_specimen-403"><span class="linenos">403</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-404"><a href="#fhir_specimen-404"><span class="linenos">404</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="fhir_specimen-405"><a href="#fhir_specimen-405"><span class="linenos">405</span></a>            <span class="p">{</span>
</span><span id="fhir_specimen-406"><a href="#fhir_specimen-406"><span class="linenos">406</span></a>                <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="fhir_specimen-407"><a href="#fhir_specimen-407"><span class="linenos">407</span></a>            <span class="p">}</span>
</span><span id="fhir_specimen-408"><a href="#fhir_specimen-408"><span class="linenos">408</span></a>        <span class="p">)</span>
</span><span id="fhir_specimen-409"><a href="#fhir_specimen-409"><span class="linenos">409</span></a>    <span class="k">elif</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># todo check it&#39;s not none?</span>
</span><span id="fhir_specimen-410"><a href="#fhir_specimen-410"><span class="linenos">410</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="fhir_specimen-411"><a href="#fhir_specimen-411"><span class="linenos">411</span></a>            <span class="p">{</span>
</span><span id="fhir_specimen-412"><a href="#fhir_specimen-412"><span class="linenos">412</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="fhir_specimen-413"><a href="#fhir_specimen-413"><span class="linenos">413</span></a>            <span class="p">}</span>
</span><span id="fhir_specimen-414"><a href="#fhir_specimen-414"><span class="linenos">414</span></a>        <span class="p">)</span>
</span><span id="fhir_specimen-415"><a href="#fhir_specimen-415"><span class="linenos">415</span></a>
</span><span id="fhir_specimen-416"><a href="#fhir_specimen-416"><span class="linenos">416</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">concentration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-417"><a href="#fhir_specimen-417"><span class="linenos">417</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-418"><a href="#fhir_specimen-418"><span class="linenos">418</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/concentration&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-419"><a href="#fhir_specimen-419"><span class="linenos">419</span></a>            <span class="p">{</span><span class="s2">&quot;valueQuantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span> <span class="p">}</span> 
</span><span id="fhir_specimen-420"><a href="#fhir_specimen-420"><span class="linenos">420</span></a>        <span class="p">))</span>
</span><span id="fhir_specimen-421"><a href="#fhir_specimen-421"><span class="linenos">421</span></a>
</span><span id="fhir_specimen-422"><a href="#fhir_specimen-422"><span class="linenos">422</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">samplingdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-423"><a href="#fhir_specimen-423"><span class="linenos">423</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;collection&quot;</span><span class="p">][</span><span class="s2">&quot;collectedDateTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">samplingdate</span><span class="p">)</span>
</span><span id="fhir_specimen-424"><a href="#fhir_specimen-424"><span class="linenos">424</span></a>  
</span><span id="fhir_specimen-425"><a href="#fhir_specimen-425"><span class="linenos">425</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">receiptdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-426"><a href="#fhir_specimen-426"><span class="linenos">426</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;receivedTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">receiptdate</span><span class="p">)</span>
</span><span id="fhir_specimen-427"><a href="#fhir_specimen-427"><span class="linenos">427</span></a>
</span><span id="fhir_specimen-428"><a href="#fhir_specimen-428"><span class="linenos">428</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">repositiondate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-429"><a href="#fhir_specimen-429"><span class="linenos">429</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_extension</span><span class="p">(</span>
</span><span id="fhir_specimen-430"><a href="#fhir_specimen-430"><span class="linenos">430</span></a>            <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/repositionDate&quot;</span><span class="p">,</span>
</span><span id="fhir_specimen-431"><a href="#fhir_specimen-431"><span class="linenos">431</span></a>            <span class="p">{</span> <span class="s2">&quot;valueDateTime&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">repositiondate</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span id="fhir_specimen-432"><a href="#fhir_specimen-432"><span class="linenos">432</span></a>        <span class="p">))</span>
</span><span id="fhir_specimen-433"><a href="#fhir_specimen-433"><span class="linenos">433</span></a>
</span><span id="fhir_specimen-434"><a href="#fhir_specimen-434"><span class="linenos">434</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">initialamount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-435"><a href="#fhir_specimen-435"><span class="linenos">435</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;collection&quot;</span><span class="p">][</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fhir_quantity</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">initialamount</span><span class="p">)</span>
</span><span id="fhir_specimen-436"><a href="#fhir_specimen-436"><span class="linenos">436</span></a>
</span><span id="fhir_specimen-437"><a href="#fhir_specimen-437"><span class="linenos">437</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">restamount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-438"><a href="#fhir_specimen-438"><span class="linenos">438</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;container&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;specimenQuantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fhir_quantity</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">restamount</span><span class="p">)</span>
</span><span id="fhir_specimen-439"><a href="#fhir_specimen-439"><span class="linenos">439</span></a>
</span><span id="fhir_specimen-440"><a href="#fhir_specimen-440"><span class="linenos">440</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_specimen-441"><a href="#fhir_specimen-441"><span class="linenos">441</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">][</span><span class="s2">&quot;coding&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">type</span><span class="p">))</span> <span class="p">)</span> <span class="c1"># material</span>
</span><span id="fhir_specimen-442"><a href="#fhir_specimen-442"><span class="linenos">442</span></a>
</span><span id="fhir_specimen-443"><a href="#fhir_specimen-443"><span class="linenos">443</span></a>    <span class="k">return</span> <span class="n">entry</span>
</span></pre></div>


            <div class="docstring"><p>fhir_specimen builds a fhir specimen. pass the sample's fhirid as an Identifier with code "fhirid" for the sample, and, for deriveds, the fhirid of its parent aliquotgroup as an Identifier with code "fhirid" of sample.parent. by tying the fhirids directly to the sample, calling methods can receive fhirids for lists of Samples e.g. from csv without having to sneak them in via an extra argument.</p>
</div>


                </section>
                <section id="fhir_quantity">
                            <input id="fhir_quantity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_quantity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">amount</span><span class="p">:</span> <span class="n">tram</span><span class="o">.</span><span class="n">Amount</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">system</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;urn:centraxx&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_quantity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_quantity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_quantity-445"><a href="#fhir_quantity-445"><span class="linenos">445</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_quantity</span><span class="p">(</span><span class="n">amount</span><span class="p">:</span><span class="n">Amount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;urn:centraxx&quot;</span><span class="p">):</span>
</span><span id="fhir_quantity-446"><a href="#fhir_quantity-446"><span class="linenos">446</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_quantity builds a fhir quantity.&quot;&quot;&quot;</span>
</span><span id="fhir_quantity-447"><a href="#fhir_quantity-447"><span class="linenos">447</span></a>    <span class="n">quant</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_quantity-448"><a href="#fhir_quantity-448"><span class="linenos">448</span></a>        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">amount</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="fhir_quantity-449"><a href="#fhir_quantity-449"><span class="linenos">449</span></a>        <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">amount</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="k">if</span> <span class="n">amount</span><span class="o">.</span><span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="fhir_quantity-450"><a href="#fhir_quantity-450"><span class="linenos">450</span></a>        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">system</span>
</span><span id="fhir_quantity-451"><a href="#fhir_quantity-451"><span class="linenos">451</span></a>    <span class="p">}</span>
</span><span id="fhir_quantity-452"><a href="#fhir_quantity-452"><span class="linenos">452</span></a>    <span class="k">return</span> <span class="n">quant</span>
</span></pre></div>


            <div class="docstring"><p>fhir_quantity builds a fhir quantity.</p>
</div>


                </section>
                <section id="fhir_aliquotgroup">
                            <input id="fhir_aliquotgroup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_aliquotgroup</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">sample</span><span class="p">:</span> <span class="n">tram</span><span class="o">.</span><span class="n">Sample</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">fhirid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">parent_fhirid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">update_with_overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_aliquotgroup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_aliquotgroup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_aliquotgroup-454"><a href="#fhir_aliquotgroup-454"><span class="linenos">454</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_aliquotgroup</span><span class="p">(</span>
</span><span id="fhir_aliquotgroup-455"><a href="#fhir_aliquotgroup-455"><span class="linenos">455</span></a>        <span class="n">sample</span><span class="p">:</span><span class="n">Sample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-456"><a href="#fhir_aliquotgroup-456"><span class="linenos">456</span></a>        <span class="n">fhirid</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-457"><a href="#fhir_aliquotgroup-457"><span class="linenos">457</span></a>        <span class="n">parent_fhirid</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-458"><a href="#fhir_aliquotgroup-458"><span class="linenos">458</span></a>        <span class="n">update_with_overwrite</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>
</span><span id="fhir_aliquotgroup-459"><a href="#fhir_aliquotgroup-459"><span class="linenos">459</span></a><span class="p">):</span>
</span><span id="fhir_aliquotgroup-460"><a href="#fhir_aliquotgroup-460"><span class="linenos">460</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_aliquotgroup builds a fhir aliquotgroup from a Sample. pass fhirids as Identifiers with code &quot;fhirid&quot; of sample and sample.parent.&quot;&quot;&quot;</span>
</span><span id="fhir_aliquotgroup-461"><a href="#fhir_aliquotgroup-461"><span class="linenos">461</span></a>    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_aliquotgroup-462"><a href="#fhir_aliquotgroup-462"><span class="linenos">462</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-463"><a href="#fhir_aliquotgroup-463"><span class="linenos">463</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_aliquotgroup-464"><a href="#fhir_aliquotgroup-464"><span class="linenos">464</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Specimen&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-465"><a href="#fhir_aliquotgroup-465"><span class="linenos">465</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-466"><a href="#fhir_aliquotgroup-466"><span class="linenos">466</span></a>            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_aliquotgroup-467"><a href="#fhir_aliquotgroup-467"><span class="linenos">467</span></a>                <span class="p">{</span>
</span><span id="fhir_aliquotgroup-468"><a href="#fhir_aliquotgroup-468"><span class="linenos">468</span></a>                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/updateWithOverwrite&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-469"><a href="#fhir_aliquotgroup-469"><span class="linenos">469</span></a>                    <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="n">update_with_overwrite</span>
</span><span id="fhir_aliquotgroup-470"><a href="#fhir_aliquotgroup-470"><span class="linenos">470</span></a>                <span class="p">},</span>
</span><span id="fhir_aliquotgroup-471"><a href="#fhir_aliquotgroup-471"><span class="linenos">471</span></a>                <span class="p">{</span>
</span><span id="fhir_aliquotgroup-472"><a href="#fhir_aliquotgroup-472"><span class="linenos">472</span></a>                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sample/organizationUnit&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-473"><a href="#fhir_aliquotgroup-473"><span class="linenos">473</span></a>                    <span class="s2">&quot;valueReference&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_aliquotgroup-474"><a href="#fhir_aliquotgroup-474"><span class="linenos">474</span></a>                        <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_aliquotgroup-475"><a href="#fhir_aliquotgroup-475"><span class="linenos">475</span></a>                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">orga</span><span class="p">)</span>
</span><span id="fhir_aliquotgroup-476"><a href="#fhir_aliquotgroup-476"><span class="linenos">476</span></a>                        <span class="p">}</span>
</span><span id="fhir_aliquotgroup-477"><a href="#fhir_aliquotgroup-477"><span class="linenos">477</span></a>                    <span class="p">}</span>
</span><span id="fhir_aliquotgroup-478"><a href="#fhir_aliquotgroup-478"><span class="linenos">478</span></a>                <span class="p">},</span>
</span><span id="fhir_aliquotgroup-479"><a href="#fhir_aliquotgroup-479"><span class="linenos">479</span></a>                <span class="p">{</span>
</span><span id="fhir_aliquotgroup-480"><a href="#fhir_aliquotgroup-480"><span class="linenos">480</span></a>                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sampleCategory&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-481"><a href="#fhir_aliquotgroup-481"><span class="linenos">481</span></a>                    <span class="s2">&quot;valueCoding&quot;</span><span class="p">:</span> <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;ALIQUOTGROUP&quot;</span><span class="p">)</span>
</span><span id="fhir_aliquotgroup-482"><a href="#fhir_aliquotgroup-482"><span class="linenos">482</span></a>                <span class="p">},</span>
</span><span id="fhir_aliquotgroup-483"><a href="#fhir_aliquotgroup-483"><span class="linenos">483</span></a>                <span class="p">{</span>
</span><span id="fhir_aliquotgroup-484"><a href="#fhir_aliquotgroup-484"><span class="linenos">484</span></a>                    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-485"><a href="#fhir_aliquotgroup-485"><span class="linenos">485</span></a>                    <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="fhir_aliquotgroup-486"><a href="#fhir_aliquotgroup-486"><span class="linenos">486</span></a>                        <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/sprec/useSprec&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-487"><a href="#fhir_aliquotgroup-487"><span class="linenos">487</span></a>                        <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="fhir_aliquotgroup-488"><a href="#fhir_aliquotgroup-488"><span class="linenos">488</span></a>                    <span class="p">}]</span>
</span><span id="fhir_aliquotgroup-489"><a href="#fhir_aliquotgroup-489"><span class="linenos">489</span></a>                <span class="p">}</span>
</span><span id="fhir_aliquotgroup-490"><a href="#fhir_aliquotgroup-490"><span class="linenos">490</span></a>            <span class="p">],</span>
</span><span id="fhir_aliquotgroup-491"><a href="#fhir_aliquotgroup-491"><span class="linenos">491</span></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unavailable&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-492"><a href="#fhir_aliquotgroup-492"><span class="linenos">492</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_aliquotgroup-493"><a href="#fhir_aliquotgroup-493"><span class="linenos">493</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_aliquotgroup-494"><a href="#fhir_aliquotgroup-494"><span class="linenos">494</span></a>                    <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="fhir_aliquotgroup-495"><a href="#fhir_aliquotgroup-495"><span class="linenos">495</span></a>                <span class="p">]</span>
</span><span id="fhir_aliquotgroup-496"><a href="#fhir_aliquotgroup-496"><span class="linenos">496</span></a>            <span class="p">},</span>
</span><span id="fhir_aliquotgroup-497"><a href="#fhir_aliquotgroup-497"><span class="linenos">497</span></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_aliquotgroup-498"><a href="#fhir_aliquotgroup-498"><span class="linenos">498</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="fhir_aliquotgroup-499"><a href="#fhir_aliquotgroup-499"><span class="linenos">499</span></a>            <span class="p">},</span>
</span><span id="fhir_aliquotgroup-500"><a href="#fhir_aliquotgroup-500"><span class="linenos">500</span></a>            <span class="c1"># &quot;receivedTime&quot;: added later</span>
</span><span id="fhir_aliquotgroup-501"><a href="#fhir_aliquotgroup-501"><span class="linenos">501</span></a>            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="p">],</span> <span class="c1"># filled later </span>
</span><span id="fhir_aliquotgroup-502"><a href="#fhir_aliquotgroup-502"><span class="linenos">502</span></a>
</span><span id="fhir_aliquotgroup-503"><a href="#fhir_aliquotgroup-503"><span class="linenos">503</span></a>        <span class="p">},</span>
</span><span id="fhir_aliquotgroup-504"><a href="#fhir_aliquotgroup-504"><span class="linenos">504</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_aliquotgroup-505"><a href="#fhir_aliquotgroup-505"><span class="linenos">505</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="fhir_aliquotgroup-506"><a href="#fhir_aliquotgroup-506"><span class="linenos">506</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="fhir_aliquotgroup-507"><a href="#fhir_aliquotgroup-507"><span class="linenos">507</span></a>        <span class="p">}</span>
</span><span id="fhir_aliquotgroup-508"><a href="#fhir_aliquotgroup-508"><span class="linenos">508</span></a>    <span class="p">}</span>
</span><span id="fhir_aliquotgroup-509"><a href="#fhir_aliquotgroup-509"><span class="linenos">509</span></a>
</span><span id="fhir_aliquotgroup-510"><a href="#fhir_aliquotgroup-510"><span class="linenos">510</span></a>    <span class="c1"># if the parent&#39;s fhirid is given, use it to reference the parent, else use the sampleid of the parent</span>
</span><span id="fhir_aliquotgroup-511"><a href="#fhir_aliquotgroup-511"><span class="linenos">511</span></a>
</span><span id="fhir_aliquotgroup-512"><a href="#fhir_aliquotgroup-512"><span class="linenos">512</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_aliquotgroup-513"><a href="#fhir_aliquotgroup-513"><span class="linenos">513</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="fhir_aliquotgroup-514"><a href="#fhir_aliquotgroup-514"><span class="linenos">514</span></a>            <span class="p">{</span>
</span><span id="fhir_aliquotgroup-515"><a href="#fhir_aliquotgroup-515"><span class="linenos">515</span></a>                <span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Specimen/</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s1">&#39;fhirid&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="fhir_aliquotgroup-516"><a href="#fhir_aliquotgroup-516"><span class="linenos">516</span></a>            <span class="p">}</span>
</span><span id="fhir_aliquotgroup-517"><a href="#fhir_aliquotgroup-517"><span class="linenos">517</span></a>        <span class="p">)</span>
</span><span id="fhir_aliquotgroup-518"><a href="#fhir_aliquotgroup-518"><span class="linenos">518</span></a>    <span class="k">elif</span> <span class="n">sample</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
</span><span id="fhir_aliquotgroup-519"><a href="#fhir_aliquotgroup-519"><span class="linenos">519</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="fhir_aliquotgroup-520"><a href="#fhir_aliquotgroup-520"><span class="linenos">520</span></a>            <span class="p">{</span>
</span><span id="fhir_aliquotgroup-521"><a href="#fhir_aliquotgroup-521"><span class="linenos">521</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="fhir_aliquotgroup-522"><a href="#fhir_aliquotgroup-522"><span class="linenos">522</span></a>            <span class="p">}</span>
</span><span id="fhir_aliquotgroup-523"><a href="#fhir_aliquotgroup-523"><span class="linenos">523</span></a>        <span class="p">)</span>
</span><span id="fhir_aliquotgroup-524"><a href="#fhir_aliquotgroup-524"><span class="linenos">524</span></a>
</span><span id="fhir_aliquotgroup-525"><a href="#fhir_aliquotgroup-525"><span class="linenos">525</span></a>
</span><span id="fhir_aliquotgroup-526"><a href="#fhir_aliquotgroup-526"><span class="linenos">526</span></a>    <span class="k">if</span> <span class="n">sample</span><span class="o">.</span><span class="n">receiptdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_aliquotgroup-527"><a href="#fhir_aliquotgroup-527"><span class="linenos">527</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;receivedTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">receiptdate</span><span class="p">)</span>
</span><span id="fhir_aliquotgroup-528"><a href="#fhir_aliquotgroup-528"><span class="linenos">528</span></a>
</span><span id="fhir_aliquotgroup-529"><a href="#fhir_aliquotgroup-529"><span class="linenos">529</span></a>    <span class="k">return</span> <span class="n">entry</span>
</span></pre></div>


            <div class="docstring"><p>fhir_aliquotgroup builds a fhir aliquotgroup from a Sample. pass fhirids as Identifiers with code "fhirid" of sample and sample.parent.</p>
</div>


                </section>
                <section id="fhir_bundle">
                            <input id="fhir_bundle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_bundle</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">entries</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="n">restype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">cxx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_bundle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_bundle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_bundle-533"><a href="#fhir_bundle-533"><span class="linenos">533</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_bundle</span><span class="p">(</span><span class="n">entries</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">restype</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cxx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span id="fhir_bundle-534"><a href="#fhir_bundle-534"><span class="linenos">534</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_bundle packs a list of entries into a fhir bundle.&quot;&quot;&quot;</span>
</span><span id="fhir_bundle-535"><a href="#fhir_bundle-535"><span class="linenos">535</span></a>    <span class="n">bundle</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_bundle-536"><a href="#fhir_bundle-536"><span class="linenos">536</span></a>        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;transaction&quot;</span><span class="p">,</span>
</span><span id="fhir_bundle-537"><a href="#fhir_bundle-537"><span class="linenos">537</span></a>        <span class="s2">&quot;entry&quot;</span><span class="p">:</span> <span class="n">entries</span>
</span><span id="fhir_bundle-538"><a href="#fhir_bundle-538"><span class="linenos">538</span></a>    <span class="p">}</span>
</span><span id="fhir_bundle-539"><a href="#fhir_bundle-539"><span class="linenos">539</span></a>    <span class="c1"># set resource type to bundle for cxx3, to the specific type for cxx4</span>
</span><span id="fhir_bundle-540"><a href="#fhir_bundle-540"><span class="linenos">540</span></a>    <span class="k">if</span> <span class="n">cxx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="fhir_bundle-541"><a href="#fhir_bundle-541"><span class="linenos">541</span></a>        <span class="n">bundle</span><span class="p">[</span><span class="s2">&quot;resourceType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bundle&quot;</span>
</span><span id="fhir_bundle-542"><a href="#fhir_bundle-542"><span class="linenos">542</span></a>    <span class="k">elif</span> <span class="n">cxx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="fhir_bundle-543"><a href="#fhir_bundle-543"><span class="linenos">543</span></a>        <span class="n">bundle</span><span class="p">[</span><span class="s2">&quot;resourceType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restype</span>
</span><span id="fhir_bundle-544"><a href="#fhir_bundle-544"><span class="linenos">544</span></a>
</span><span id="fhir_bundle-545"><a href="#fhir_bundle-545"><span class="linenos">545</span></a>    <span class="k">return</span> <span class="n">bundle</span>
</span></pre></div>


            <div class="docstring"><p>fhir_bundle packs a list of entries into a fhir bundle.</p>
</div>


                </section>
                <section id="fhir_obs">
                            <input id="fhir_obs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_obs</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">finding</span><span class="p">:</span> <span class="n">tram</span><span class="o">.</span><span class="n">Finding</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">fhirid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">update_with_overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">delete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_obs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_obs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_obs-548"><a href="#fhir_obs-548"><span class="linenos">548</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_obs</span><span class="p">(</span>
</span><span id="fhir_obs-549"><a href="#fhir_obs-549"><span class="linenos">549</span></a>        <span class="n">finding</span><span class="p">:</span><span class="n">Finding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="fhir_obs-550"><a href="#fhir_obs-550"><span class="linenos">550</span></a>        <span class="n">fhirid</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="fhir_obs-551"><a href="#fhir_obs-551"><span class="linenos">551</span></a>        <span class="n">update_with_overwrite</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="fhir_obs-552"><a href="#fhir_obs-552"><span class="linenos">552</span></a>        <span class="n">delete</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span>        
</span><span id="fhir_obs-553"><a href="#fhir_obs-553"><span class="linenos">553</span></a><span class="p">):</span>
</span><span id="fhir_obs-554"><a href="#fhir_obs-554"><span class="linenos">554</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_obs builds a fhir observation from Finding.&quot;&quot;&quot;</span>
</span><span id="fhir_obs-555"><a href="#fhir_obs-555"><span class="linenos">555</span></a>    <span class="k">if</span> <span class="n">finding</span><span class="o">.</span><span class="n">sample</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_obs-556"><a href="#fhir_obs-556"><span class="linenos">556</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error: no sample id&quot;</span><span class="p">)</span>
</span><span id="fhir_obs-557"><a href="#fhir_obs-557"><span class="linenos">557</span></a>        <span class="n">exit</span><span class="p">()</span>
</span><span id="fhir_obs-558"><a href="#fhir_obs-558"><span class="linenos">558</span></a>
</span><span id="fhir_obs-559"><a href="#fhir_obs-559"><span class="linenos">559</span></a>    <span class="c1"># if no fhirid given, generate</span>
</span><span id="fhir_obs-560"><a href="#fhir_obs-560"><span class="linenos">560</span></a>    <span class="k">if</span> <span class="n">fhirid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_obs-561"><a href="#fhir_obs-561"><span class="linenos">561</span></a>        <span class="n">fhirid</span> <span class="o">=</span> <span class="n">genfhirid</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
</span><span id="fhir_obs-562"><a href="#fhir_obs-562"><span class="linenos">562</span></a>
</span><span id="fhir_obs-563"><a href="#fhir_obs-563"><span class="linenos">563</span></a>    <span class="c1"># if delete is set to true, change method to delete</span>
</span><span id="fhir_obs-564"><a href="#fhir_obs-564"><span class="linenos">564</span></a>    <span class="n">fhirmethod</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span> <span class="c1"># write observation</span>
</span><span id="fhir_obs-565"><a href="#fhir_obs-565"><span class="linenos">565</span></a>    <span class="k">if</span> <span class="n">delete</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="fhir_obs-566"><a href="#fhir_obs-566"><span class="linenos">566</span></a>        <span class="n">fhirmethod</span> <span class="o">=</span> <span class="s2">&quot;DELETE&quot;</span>
</span><span id="fhir_obs-567"><a href="#fhir_obs-567"><span class="linenos">567</span></a>
</span><span id="fhir_obs-568"><a href="#fhir_obs-568"><span class="linenos">568</span></a>    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>              
</span><span id="fhir_obs-569"><a href="#fhir_obs-569"><span class="linenos">569</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Observation/</span><span class="si">{</span><span class="n">fhirid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="fhir_obs-570"><a href="#fhir_obs-570"><span class="linenos">570</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_obs-571"><a href="#fhir_obs-571"><span class="linenos">571</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fhirmethod</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="fhir_obs-572"><a href="#fhir_obs-572"><span class="linenos">572</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Observation/</span><span class="si">{</span><span class="n">fhirid</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="fhir_obs-573"><a href="#fhir_obs-573"><span class="linenos">573</span></a>        <span class="p">},</span>
</span><span id="fhir_obs-574"><a href="#fhir_obs-574"><span class="linenos">574</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_obs-575"><a href="#fhir_obs-575"><span class="linenos">575</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Observation&quot;</span><span class="p">,</span>
</span><span id="fhir_obs-576"><a href="#fhir_obs-576"><span class="linenos">576</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">fhirid</span><span class="p">),</span>
</span><span id="fhir_obs-577"><a href="#fhir_obs-577"><span class="linenos">577</span></a>            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_obs-578"><a href="#fhir_obs-578"><span class="linenos">578</span></a>            <span class="p">{</span>
</span><span id="fhir_obs-579"><a href="#fhir_obs-579"><span class="linenos">579</span></a>                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/updateWithOverwrite&quot;</span><span class="p">,</span>
</span><span id="fhir_obs-580"><a href="#fhir_obs-580"><span class="linenos">580</span></a>                <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="n">update_with_overwrite</span>
</span><span id="fhir_obs-581"><a href="#fhir_obs-581"><span class="linenos">581</span></a>            <span class="p">}</span>
</span><span id="fhir_obs-582"><a href="#fhir_obs-582"><span class="linenos">582</span></a>            <span class="p">],</span>
</span><span id="fhir_obs-583"><a href="#fhir_obs-583"><span class="linenos">583</span></a>                
</span><span id="fhir_obs-584"><a href="#fhir_obs-584"><span class="linenos">584</span></a>            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
</span><span id="fhir_obs-585"><a href="#fhir_obs-585"><span class="linenos">585</span></a>            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_obs-586"><a href="#fhir_obs-586"><span class="linenos">586</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_obs-587"><a href="#fhir_obs-587"><span class="linenos">587</span></a>                    <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">methodname</span><span class="p">))</span>
</span><span id="fhir_obs-588"><a href="#fhir_obs-588"><span class="linenos">588</span></a>                <span class="p">]</span>
</span><span id="fhir_obs-589"><a href="#fhir_obs-589"><span class="linenos">589</span></a>            <span class="p">},</span>
</span><span id="fhir_obs-590"><a href="#fhir_obs-590"><span class="linenos">590</span></a>            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_obs-591"><a href="#fhir_obs-591"><span class="linenos">591</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">patient</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="fhir_obs-592"><a href="#fhir_obs-592"><span class="linenos">592</span></a>            <span class="p">},</span>
</span><span id="fhir_obs-593"><a href="#fhir_obs-593"><span class="linenos">593</span></a>            <span class="s2">&quot;effectiveDateTime&quot;</span><span class="p">:</span> <span class="n">datestring</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">findingdate</span><span class="p">),</span> 
</span><span id="fhir_obs-594"><a href="#fhir_obs-594"><span class="linenos">594</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_obs-595"><a href="#fhir_obs-595"><span class="linenos">595</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_obs-596"><a href="#fhir_obs-596"><span class="linenos">596</span></a>                    <span class="p">{</span>
</span><span id="fhir_obs-597"><a href="#fhir_obs-597"><span class="linenos">597</span></a>                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:centraxx&quot;</span><span class="p">,</span>
</span><span id="fhir_obs-598"><a href="#fhir_obs-598"><span class="linenos">598</span></a>                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="fhir_obs-599"><a href="#fhir_obs-599"><span class="linenos">599</span></a>                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</span><span id="fhir_obs-600"><a href="#fhir_obs-600"><span class="linenos">600</span></a>                    <span class="p">}</span>
</span><span id="fhir_obs-601"><a href="#fhir_obs-601"><span class="linenos">601</span></a>                <span class="p">]</span>
</span><span id="fhir_obs-602"><a href="#fhir_obs-602"><span class="linenos">602</span></a>            <span class="p">},</span>
</span><span id="fhir_obs-603"><a href="#fhir_obs-603"><span class="linenos">603</span></a>            <span class="s2">&quot;specimen&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_obs-604"><a href="#fhir_obs-604"><span class="linenos">604</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="n">fhir_identifier</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</span><span id="fhir_obs-605"><a href="#fhir_obs-605"><span class="linenos">605</span></a>            <span class="p">},</span>
</span><span id="fhir_obs-606"><a href="#fhir_obs-606"><span class="linenos">606</span></a>            <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="fhir_obs-607"><a href="#fhir_obs-607"><span class="linenos">607</span></a>        <span class="p">}</span>
</span><span id="fhir_obs-608"><a href="#fhir_obs-608"><span class="linenos">608</span></a>    <span class="p">}</span>
</span><span id="fhir_obs-609"><a href="#fhir_obs-609"><span class="linenos">609</span></a>
</span><span id="fhir_obs-610"><a href="#fhir_obs-610"><span class="linenos">610</span></a>    <span class="c1"># die messparameter landen in components</span>
</span><span id="fhir_obs-611"><a href="#fhir_obs-611"><span class="linenos">611</span></a>    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">finding</span><span class="o">.</span><span class="n">recs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="fhir_obs-612"><a href="#fhir_obs-612"><span class="linenos">612</span></a>        <span class="c1"># don&#39;t put in empty values</span>
</span><span id="fhir_obs-613"><a href="#fhir_obs-613"><span class="linenos">613</span></a>        <span class="k">if</span> <span class="n">rec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_obs-614"><a href="#fhir_obs-614"><span class="linenos">614</span></a>            <span class="k">continue</span>
</span><span id="fhir_obs-615"><a href="#fhir_obs-615"><span class="linenos">615</span></a>        <span class="n">comp</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_obs-616"><a href="#fhir_obs-616"><span class="linenos">616</span></a>            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_obs-617"><a href="#fhir_obs-617"><span class="linenos">617</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_obs-618"><a href="#fhir_obs-618"><span class="linenos">618</span></a>                    <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
</span><span id="fhir_obs-619"><a href="#fhir_obs-619"><span class="linenos">619</span></a>                <span class="p">]</span>
</span><span id="fhir_obs-620"><a href="#fhir_obs-620"><span class="linenos">620</span></a>            <span class="p">}</span>
</span><span id="fhir_obs-621"><a href="#fhir_obs-621"><span class="linenos">621</span></a>        <span class="p">}</span>
</span><span id="fhir_obs-622"><a href="#fhir_obs-622"><span class="linenos">622</span></a>        <span class="c1"># put something different depending on the type of the rec</span>
</span><span id="fhir_obs-623"><a href="#fhir_obs-623"><span class="linenos">623</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BooleanRec</span><span class="p">:</span>
</span><span id="fhir_obs-624"><a href="#fhir_obs-624"><span class="linenos">624</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueBoolean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="fhir_obs-625"><a href="#fhir_obs-625"><span class="linenos">625</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">NumberRec</span><span class="p">:</span> <span class="c1"># are numbers always turned to quantities? # todo</span>
</span><span id="fhir_obs-626"><a href="#fhir_obs-626"><span class="linenos">626</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueQuantity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_obs-627"><a href="#fhir_obs-627"><span class="linenos">627</span></a>                <span class="c1"># shouldn&#39;t NumberRec.value already be a float?</span>
</span><span id="fhir_obs-628"><a href="#fhir_obs-628"><span class="linenos">628</span></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># todo setting 0 is not right actually, cause the db returns NULL, but None isn&#39;t accepted by fhirimporter </span>
</span><span id="fhir_obs-629"><a href="#fhir_obs-629"><span class="linenos">629</span></a>            <span class="p">}</span>
</span><span id="fhir_obs-630"><a href="#fhir_obs-630"><span class="linenos">630</span></a>            <span class="c1"># set the unit only if it is there</span>
</span><span id="fhir_obs-631"><a href="#fhir_obs-631"><span class="linenos">631</span></a>            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;valueQuantity&quot;</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">:</span>
</span><span id="fhir_obs-632"><a href="#fhir_obs-632"><span class="linenos">632</span></a>                <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueQuantity&quot;</span><span class="p">][</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">unit</span> <span class="c1"># from laborvalue</span>
</span><span id="fhir_obs-633"><a href="#fhir_obs-633"><span class="linenos">633</span></a>
</span><span id="fhir_obs-634"><a href="#fhir_obs-634"><span class="linenos">634</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">StringRec</span><span class="p">:</span>
</span><span id="fhir_obs-635"><a href="#fhir_obs-635"><span class="linenos">635</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueString&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="fhir_obs-636"><a href="#fhir_obs-636"><span class="linenos">636</span></a>            <span class="c1"># somehow strings may not be empty or null, so don&#39;t add the component if that&#39;s the case? todo how to delete a string?</span>
</span><span id="fhir_obs-637"><a href="#fhir_obs-637"><span class="linenos">637</span></a>            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="fhir_obs-638"><a href="#fhir_obs-638"><span class="linenos">638</span></a>                <span class="k">continue</span> <span class="c1"># continue without adding the component</span>
</span><span id="fhir_obs-639"><a href="#fhir_obs-639"><span class="linenos">639</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DateRec</span><span class="p">:</span> 
</span><span id="fhir_obs-640"><a href="#fhir_obs-640"><span class="linenos">640</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueDateTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datestring</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> 
</span><span id="fhir_obs-641"><a href="#fhir_obs-641"><span class="linenos">641</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">MultiRec</span><span class="p">:</span>
</span><span id="fhir_obs-642"><a href="#fhir_obs-642"><span class="linenos">642</span></a>            <span class="c1"># collect the values </span>
</span><span id="fhir_obs-643"><a href="#fhir_obs-643"><span class="linenos">643</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="fhir_obs-644"><a href="#fhir_obs-644"><span class="linenos">644</span></a>            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="fhir_obs-645"><a href="#fhir_obs-645"><span class="linenos">645</span></a>                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="fhir_obs-646"><a href="#fhir_obs-646"><span class="linenos">646</span></a>                    <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;urn:centraxx:CodeSystem/UsageEntry-x&quot;</span><span class="p">,</span> <span class="c1"># sometimes the x is oid, but doesn&#39;t seem to need to be</span>
</span><span id="fhir_obs-647"><a href="#fhir_obs-647"><span class="linenos">647</span></a>                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="fhir_obs-648"><a href="#fhir_obs-648"><span class="linenos">648</span></a>                    <span class="p">})</span>
</span><span id="fhir_obs-649"><a href="#fhir_obs-649"><span class="linenos">649</span></a>            <span class="c1"># put the collected values into the coding field of a value codeable concept</span>
</span><span id="fhir_obs-650"><a href="#fhir_obs-650"><span class="linenos">650</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueCodeableConcept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_obs-651"><a href="#fhir_obs-651"><span class="linenos">651</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="n">a</span>
</span><span id="fhir_obs-652"><a href="#fhir_obs-652"><span class="linenos">652</span></a>            <span class="p">}</span>
</span><span id="fhir_obs-653"><a href="#fhir_obs-653"><span class="linenos">653</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="ow">is</span> <span class="n">CatalogRec</span><span class="p">:</span>
</span><span id="fhir_obs-654"><a href="#fhir_obs-654"><span class="linenos">654</span></a>            <span class="c1"># collect the values </span>
</span><span id="fhir_obs-655"><a href="#fhir_obs-655"><span class="linenos">655</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="fhir_obs-656"><a href="#fhir_obs-656"><span class="linenos">656</span></a>            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="fhir_obs-657"><a href="#fhir_obs-657"><span class="linenos">657</span></a>                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="fhir_obs-658"><a href="#fhir_obs-658"><span class="linenos">658</span></a>                    <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;urn:centraxx:CodeSystem/ValueList-</span><span class="si">{</span><span class="n">rec</span><span class="o">.</span><span class="n">catalog</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="c1"># here apparently the catalog code is needed</span>
</span><span id="fhir_obs-659"><a href="#fhir_obs-659"><span class="linenos">659</span></a>                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="fhir_obs-660"><a href="#fhir_obs-660"><span class="linenos">660</span></a>                    <span class="p">})</span>
</span><span id="fhir_obs-661"><a href="#fhir_obs-661"><span class="linenos">661</span></a>            <span class="c1"># put the collected values into the coding field of a value codeable concept</span>
</span><span id="fhir_obs-662"><a href="#fhir_obs-662"><span class="linenos">662</span></a>            <span class="n">comp</span><span class="p">[</span><span class="s2">&quot;valueCodeableConcept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_obs-663"><a href="#fhir_obs-663"><span class="linenos">663</span></a>                <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="n">a</span>
</span><span id="fhir_obs-664"><a href="#fhir_obs-664"><span class="linenos">664</span></a>            <span class="p">}</span>
</span><span id="fhir_obs-665"><a href="#fhir_obs-665"><span class="linenos">665</span></a>            
</span><span id="fhir_obs-666"><a href="#fhir_obs-666"><span class="linenos">666</span></a>
</span><span id="fhir_obs-667"><a href="#fhir_obs-667"><span class="linenos">667</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;component&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
</span><span id="fhir_obs-668"><a href="#fhir_obs-668"><span class="linenos">668</span></a>
</span><span id="fhir_obs-669"><a href="#fhir_obs-669"><span class="linenos">669</span></a>    <span class="c1"># add the sender</span>
</span><span id="fhir_obs-670"><a href="#fhir_obs-670"><span class="linenos">670</span></a>    <span class="k">if</span> <span class="n">finding</span><span class="o">.</span><span class="n">sender</span><span class="p">:</span>
</span><span id="fhir_obs-671"><a href="#fhir_obs-671"><span class="linenos">671</span></a>        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;component&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="fhir_obs-672"><a href="#fhir_obs-672"><span class="linenos">672</span></a>        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_obs-673"><a href="#fhir_obs-673"><span class="linenos">673</span></a>            <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="fhir_obs-674"><a href="#fhir_obs-674"><span class="linenos">674</span></a>                <span class="n">fhir_coding</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;EINS_CODE&quot;</span><span class="p">)</span>
</span><span id="fhir_obs-675"><a href="#fhir_obs-675"><span class="linenos">675</span></a>            <span class="p">]</span>
</span><span id="fhir_obs-676"><a href="#fhir_obs-676"><span class="linenos">676</span></a>        <span class="p">},</span>
</span><span id="fhir_obs-677"><a href="#fhir_obs-677"><span class="linenos">677</span></a>        <span class="s2">&quot;valueString&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">finding</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
</span><span id="fhir_obs-678"><a href="#fhir_obs-678"><span class="linenos">678</span></a>        <span class="p">})</span>
</span><span id="fhir_obs-679"><a href="#fhir_obs-679"><span class="linenos">679</span></a>
</span><span id="fhir_obs-680"><a href="#fhir_obs-680"><span class="linenos">680</span></a>    <span class="k">return</span> <span class="n">entry</span>
</span></pre></div>


            <div class="docstring"><p>fhir_obs builds a fhir observation from Finding.</p>
</div>


                </section>
                <section id="fhir_patient">
                            <input id="fhir_patient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fhir_patient</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">patient</span><span class="p">:</span> <span class="n">tram</span><span class="o">.</span><span class="n">Patient</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">update_with_overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fhir_patient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fhir_patient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fhir_patient-684"><a href="#fhir_patient-684"><span class="linenos">684</span></a><span class="k">def</span><span class="w"> </span><span class="nf">fhir_patient</span><span class="p">(</span><span class="n">patient</span><span class="p">:</span><span class="n">Patient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_with_overwrite</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="fhir_patient-685"><a href="#fhir_patient-685"><span class="linenos">685</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;fhir_patient baut einen patienten.&quot;&quot;&quot;</span>
</span><span id="fhir_patient-686"><a href="#fhir_patient-686"><span class="linenos">686</span></a>
</span><span id="fhir_patient-687"><a href="#fhir_patient-687"><span class="linenos">687</span></a>    <span class="c1"># if there isn&#39;t a fhirid, make it based on the patient&#39;s main id</span>
</span><span id="fhir_patient-688"><a href="#fhir_patient-688"><span class="linenos">688</span></a>    <span class="c1"># the fhirid needs to be unique for the patient, it is also written to the db and patient records can be updated with it</span>
</span><span id="fhir_patient-689"><a href="#fhir_patient-689"><span class="linenos">689</span></a>    <span class="n">fhirid</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="s2">&quot;fhirid&quot;</span><span class="p">)</span>
</span><span id="fhir_patient-690"><a href="#fhir_patient-690"><span class="linenos">690</span></a>    <span class="k">if</span> <span class="n">fhirid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fhir_patient-691"><a href="#fhir_patient-691"><span class="linenos">691</span></a>        <span class="n">fhirid</span> <span class="o">=</span> <span class="n">genfhirid</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
</span><span id="fhir_patient-692"><a href="#fhir_patient-692"><span class="linenos">692</span></a>
</span><span id="fhir_patient-693"><a href="#fhir_patient-693"><span class="linenos">693</span></a>    <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="fhir_patient-694"><a href="#fhir_patient-694"><span class="linenos">694</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Patient/</span><span class="si">{</span><span class="n">fhirid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="fhir_patient-695"><a href="#fhir_patient-695"><span class="linenos">695</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_patient-696"><a href="#fhir_patient-696"><span class="linenos">696</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">,</span>
</span><span id="fhir_patient-697"><a href="#fhir_patient-697"><span class="linenos">697</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">fhirid</span><span class="p">,</span>
</span><span id="fhir_patient-698"><a href="#fhir_patient-698"><span class="linenos">698</span></a>            <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="fhir_patient-699"><a href="#fhir_patient-699"><span class="linenos">699</span></a>                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://fhir.centraxx.de/extension/updateWithOverwrite&quot;</span><span class="p">,</span>
</span><span id="fhir_patient-700"><a href="#fhir_patient-700"><span class="linenos">700</span></a>                <span class="s2">&quot;valueBoolean&quot;</span><span class="p">:</span> <span class="n">update_with_overwrite</span>
</span><span id="fhir_patient-701"><a href="#fhir_patient-701"><span class="linenos">701</span></a>            <span class="p">}],</span>
</span><span id="fhir_patient-702"><a href="#fhir_patient-702"><span class="linenos">702</span></a>            <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># filled later</span>
</span><span id="fhir_patient-703"><a href="#fhir_patient-703"><span class="linenos">703</span></a>            <span class="s2">&quot;generalPractitioner&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span>
</span><span id="fhir_patient-704"><a href="#fhir_patient-704"><span class="linenos">704</span></a>                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_patient-705"><a href="#fhir_patient-705"><span class="linenos">705</span></a>                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">orga</span><span class="p">)</span>
</span><span id="fhir_patient-706"><a href="#fhir_patient-706"><span class="linenos">706</span></a>                <span class="p">}</span>
</span><span id="fhir_patient-707"><a href="#fhir_patient-707"><span class="linenos">707</span></a>            <span class="p">}</span> <span class="p">]</span>
</span><span id="fhir_patient-708"><a href="#fhir_patient-708"><span class="linenos">708</span></a>        <span class="p">},</span>
</span><span id="fhir_patient-709"><a href="#fhir_patient-709"><span class="linenos">709</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="fhir_patient-710"><a href="#fhir_patient-710"><span class="linenos">710</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="fhir_patient-711"><a href="#fhir_patient-711"><span class="linenos">711</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Patient/</span><span class="si">{</span><span class="n">fhirid</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="fhir_patient-712"><a href="#fhir_patient-712"><span class="linenos">712</span></a>        <span class="p">}</span>
</span><span id="fhir_patient-713"><a href="#fhir_patient-713"><span class="linenos">713</span></a>    <span class="p">}</span>
</span><span id="fhir_patient-714"><a href="#fhir_patient-714"><span class="linenos">714</span></a>
</span><span id="fhir_patient-715"><a href="#fhir_patient-715"><span class="linenos">715</span></a>    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">patient</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
</span><span id="fhir_patient-716"><a href="#fhir_patient-716"><span class="linenos">716</span></a>        <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;oid&quot;</span> <span class="ow">and</span> <span class="nb">id</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s2">&quot;fhirid&quot;</span><span class="p">:</span>
</span><span id="fhir_patient-717"><a href="#fhir_patient-717"><span class="linenos">717</span></a>             <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">][</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fhir_identifier</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
</span><span id="fhir_patient-718"><a href="#fhir_patient-718"><span class="linenos">718</span></a>
</span><span id="fhir_patient-719"><a href="#fhir_patient-719"><span class="linenos">719</span></a>    
</span><span id="fhir_patient-720"><a href="#fhir_patient-720"><span class="linenos">720</span></a>    <span class="k">return</span> <span class="n">entry</span>
</span></pre></div>


            <div class="docstring"><p>fhir_patient baut einen patienten.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>